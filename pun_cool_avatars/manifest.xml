<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
/**
 * Cool avatars.
 *
 * @copyright (C) 2008-2009 PunBB
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * @package pun_cool_avatars
 */
-->

<extension engine="1.0">
	<id>pun_cool_avatars</id>
	<title>Cool avatars</title>
	<version>0.1</version>
	<description>The extension allow to use service http://avatar.pho.to/.</description>
	<author>PunBB Development Team</author>
	<minversion>1.3</minversion>
	<maxtestedon>1.3.4</maxtestedon>
	<uninstall><![CDATA[
		if (file_exists(FORUM_CACHE_DIR.'cache_pho_to_templates.php'))
			unlink(FORUM_CACHE_DIR.'cache_pho_to_templates.php');
	]]></uninstall>

	<hooks>
		<hook id="co_modify_url_scheme"><![CDATA[
$forum_url['pho.to_queue'] = 'http://ope-api.pho.to/queued.php?key=$1&image_url=$2&image_limit=$3&animated_effect:template_name=$4';
$forum_url['pho.to_get-result'] = 'http://ope-api.pho.to/get-result.php?request_id=$1&remove_limit=visit_page';
$forum_url['pho.to_AET_templates'] = 'http://ope-api.pho.to/service.php?method=get_templates&type=AET';
$forum_url['pho.to_FET_templates'] = 'http://ope-api.pho.to/service.php?method=get_templates&type=FET';
		]]></hook>
		<hook id="pf_start"><![CDATA[
define('FREE_KEY', '3CCREZBSFGLPUYAXT7RJL6KEF6EB');
define('IMAGE_LIMIT', 'watermark');
include $ext_info['path'].'/functions.php';
		]]></hook>
		<hook id="pf_new_action"><![CDATA[
if (isset($_GET['request_id']))
{
	if (!is_scalar($_GET['request_id']))
		message($lang_common['Bad request']);

	visit_pho_to_page($id, forum_trim($_GET['request_id']));
}
else if (isset($_GET['result_url']))
{
	if (!is_scalar($_GET['result_url']) || !preg_match('~\.pho\.to~', $_GET['result_url']))
		message($lang_common['Bad request']);
	$avatar_type = get_avatar_type($id);

	if (!$avatar_type)
		message($lang_common['Bad request']);

	$result_url = forum_trim($_GET['result_url']);
	rewrite_avatar($result_url, $id, $avatar_type);
}
else if (isset($_POST['apply_effect']))
{
	$pho_to_template = isset($_POST['template']) ? forum_trim($_POST['template']) : FALSE;
	if (!$pho_to_template)
		$errors[] = 'You need to select template for applaying';
	else if (!is_scalar($pho_to_template))
		message($lang_common['Bad request']);

	if (empty($errors))
	{
		$avatar_type = get_avatar_type($id);
		if (!$avatar_type)
			message($lang_common['Bad request']);

		get_new_avatar($pho_to_template, $id, $avatar_type);
	}
}
		]]></hook>
		<hook id="pf_change_details_avatar_pre_header_load"><![CDATA[
if (file_exists(FORUM_CACHE_DIR.'cache_pho_to_templates.php'))
	include FORUM_CACHE_DIR.'cache_pho_to_templates.php';
if (!defined('PHO.TO_TEMPLATES_LOADED') || $pho_to_templates['cached'] < (time() - 43200))
{
	generate_templates_cache();
	require FORUM_CACHE_DIR.'cache_pho_to_templates.php';
}
		]]></hook>
		<hook id="pf_change_details_avatar_end"><![CDATA[
if (!empty($forum_page['avatar_markup']))
	include $ext_info['path'].'/pho.to_block.php';
		]]></hook>
		<hook id="ft_about_end" priority="9"><![CDATA[
			if (!defined('PUN_EXTENSIONS_USED') && !empty($pun_extensions_used))
			{
				define('PUN_EXTENSIONS_USED', 1);
				if (count($pun_extensions_used) == 1)
					echo '<p style="clear: both; ">The '.$pun_extensions_used[0].' official extension is installed. Copyright &copy; 2003&ndash;2009 <a href="http://punbb.informer.com/">PunBB</a>.</p>';
				else
					echo '<p style="clear: both; ">Currently installed <span id="extensions-used" title="'.implode(', ', $pun_extensions_used).'.">'.count($pun_extensions_used).' official extensions</span>. Copyright &copy; 2003&ndash;2009 <a href="http://punbb.informer.com/">PunBB</a>.</p>';
			}
		]]></hook>
	</hooks>
</extension>