<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

	Copyright (C) 2008  PunBB

	PunBB is free software; you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 2 of the License,
	or (at your option) any later version.

	PunBB is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston,
	MA  02111-1307  USA

***********************************************************************
-->

<extension engine="1.0">
    <id>pun_topic_online_users</id>
    <title>Topic online users</title>
    <version>1.0b</version>
    <description>Shows who is reading or replying the topic right now.</description>
    <author>PunBB Development Team</author>

    <minversion>1.3 SVN</minversion>
    <maxtestedon>1.3 SVN</maxtestedon>
    
	<install><![CDATA[
	
		$query = 'ALTER TABLE online ADD pun_tou_tid INT(10) UNSIGNED DEFAULT "0" NOT NULL';
		$forum_db->query($query) or error(__FILE__, __LINE__);
		
	]]></install>
	
	<uninstall><![CDATA[
	
		$query = 'ALTER TABLE online DROP pun_tou_tid';
		$forum_db->query($query) or error(__FILE__, __LINE__);
		
	]]></uninstall>      

    <hooks>
    
		<hook id="hd_viewtopic_head"><![CDATA[
		
			$forum_head['style_topic_online_users'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/styles.css" />';
			
		]]></hook>

		<hook id="hd_post_head"><![CDATA[
		
			$forum_head['style_topic_online_users'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/styles.css" />';
			
		]]></hook>

		<hook id="vt_end"><![CDATA[
		
			$topic_online_uses_topic_id = $id;
			$topic_online_uses_topic_subject = isset($cur_topic['subject']) ? $cur_topic['subject'] : '';
			require FORUM_ROOT.$ext_info['path'].'/show.php';
			
		]]></hook>

		<hook id = "po_end"><![CDATA[
		
			$topic_online_uses_topic_id = $tid;
			$topic_online_uses_topic_subject = isset($cur_posting['subject']) ? $cur_posting['subject'] : '';
			require FORUM_ROOT.$ext_info['path'].'/show.php';
			
		]]></hook>

		<hook id="co_common"><![CDATA[
		
			$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));
			
		]]></hook>
		
		<hook id="ft_about_end" priority="10"><![CDATA[
		
			if (!defined('PUN_EXTENSIONS_USED') && !empty($pun_extensions_used))
			{
				define('PUN_EXTENSIONS_USED', 1);
				echo '<p id="extensions-used">Currently used extensions: '.implode(', ', $pun_extensions_used).'. Copyright &copy; 2008 <a href="http://punbb.informer.com/">PunBB</a></p>';
			}
			
		]]></hook>

		<hook id="co_modify_url_scheme"><![CDATA[
		
			if (isset($rewritten_url))
			{
				$rewritten_url_array = explode('?', $rewritten_url);
				
				if ($rewritten_url_array[0] == 'viewtopic.php')
				{
					if (isset($_GET['id']))
					{
						$topic_id = intval($_GET['id']);
						
						$query = array(
							'UPDATE'	=> 'online',
							'SET'		=> 'pun_tou_tid='.$topic_id,
							'WHERE'		=> 'user_id='.$forum_user['id']
						);
						
						$forum_db->query_build($query) or error(__FILE__, __LINE__);
					}
					else if (isset($_GET['pid']))
					{
						$post_id = intval($_GET['pid']);
						
						$query = array(
							'SELECT'	=> 'topic_id',
							'FROM'		=> 'posts',
							'WHERE'		=> 'id='.$post_id
						);
						
						$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);
						
						if ($forum_db->num_rows($result))
						{
							$topic_id = $forum_db->fetch_assoc($result);
							
							$query = array(
								'UPDATE'	=> 'online',
								'SET'		=> 'pun_tou_tid='.$topic_id['topic_id'],
								'WHERE'		=> 'user_id='.$forum_user['id']
							);				
							
							$forum_db->query_build($query) or error(__FILE__, __LINE__);
						}
						else 
						{
							$query = array(
								'UPDATE'	=> 'online',
								'SET'		=> 'pun_tou_tid=0',
								'WHERE'		=> 'user_id='.$forum_user['id']
							);
							
							$forum_db->query_build($query) or error(__FILE__, __LINE__);
						}
					}
				}
				else 
				{
					
					if ($rewritten_url_array[0] == 'post.php')
					{
						$topic_id = intval($_GET['tid']);
						
						$query = array(
							'UPDATE'	=> 'online',
							'SET'		=> 'pun_tou_tid='.$topic_id,
							'WHERE'		=> 'user_id='.$forum_user['id']
						);
						
						$forum_db->query_build($query) or error(__FILE__, __LINE__);
					
					}		
					else 
					{
						$query = array(
							'UPDATE'	=> 'online',
							'SET'		=> 'pun_tou_tid=0',
							'WHERE'		=> 'user_id='.$forum_user['id']
						);
						
						$forum_db->query_build($query) or error(__FILE__, __LINE__);
					}
				}
				
			}
			else 
			{
				$query = array(
					'UPDATE'	=> 'online',
					'SET'		=> 'pun_tou_tid=0',
					'WHERE'		=> 'user_id='.$forum_user['id']
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
			}
			
		]]></hook>		
		
    </hooks>
    
</extension>
