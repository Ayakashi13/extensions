<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
/**
 * Allows users to quote posts without a page reloading
 *
 * @copyright Copyright (C) 2008 PunBB
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * @package pun_quote
 */
-->

<extension engine="1.0">
	<id>pun_quote</id>
	<title>JS post quote</title>
	<version>2.0.3</version>
	<description>Select the text you want to quote right in the topic view. Click "Quote" for multiple quotes in quick reply form.</description>
	<author>PunBB Development Team</author>

	<minversion>1.3</minversion>
	<maxtestedon>1.3.2</maxtestedon>

	<note type="install" timing="pre">Tested in Internet Explorer 7, FireFox 3, Opera 9.63 and Google Chrome 0.2.</note>

	<hooks>
		<hook id="vt_end"><![CDATA[
			?>
			<script type="text/javascript" src="<?php echo $ext_info['url'] ?>/scripts.js"></script>
			<form id="pun_quote_form" action="post.php" method="post">
				<div class="hidden">
					<input type="hidden" value="" id="post_msg" name="post_msg"/>
					<input type="hidden" value="<?php echo forum_link($forum_url['quote'], array($id, $cur_post['id'])) ?>" id="pun_quote_url" name="pun_quote_url" />
				</div>
			</form>
			<?php
		]]></hook>

		<hook id="po_qr_get_quote"><![CDATA[
			if(isset($_POST['post_msg']))
				$query['SELECT'] = 'p.poster, \''.$forum_db->escape($_POST['post_msg']).'\'';
		]]></hook>

		<hook id="hd_head"><![CDATA[
		
			if (FORUM_PAGE == 'viewtopic')
			{
				$pun_quote_query = array(
					'SELECT'	=> 'id, message, poster',
					'FROM'		=> 'posts',
					'WHERE'		=> 'topic_id='.$id
				);
	
				$pun_quote_result = $forum_db->query_build($pun_quote_query) or error(__FILE__, __LINE__);
				
				
				$forum_head['pun_quote_js'] = '';
				
				if ($forum_db->num_rows($pun_quote_result))
				{
					$forum_head['pun_quote_js'] .= '<script type="text/javascript">';
					$forum_head['pun_quote_js'] .= 'var pun_quote_posts = new Array();';
					$forum_head['pun_quote_js'] .= 'var pun_quote_authors = new Array();';
	
					while ($pun_quote_curr_message = $forum_db->fetch_assoc($pun_quote_result))
					{
						$pun_quote_curr_message['message'] = preg_replace('/\n\r|\n|\r/', '</br id="pun_quote_tag">', $pun_quote_curr_message['message']);
						$pun_quote_curr_message['message'] = addslashes($pun_quote_curr_message['message']);
						$forum_head['pun_quote_js'] .= 'pun_quote_posts['.$pun_quote_curr_message['id'].'] = "'.$pun_quote_curr_message['message'].'";';
						$forum_head['pun_quote_js'] .= 'pun_quote_authors['.$pun_quote_curr_message['id'].'] = "'.$pun_quote_curr_message['poster'].'";';
					}
	
					$forum_head['pun_quote_js'] .= '</script>';
				}
			}

		]]></hook>

		<hook id="vt_row_pre_post_actions_merge"><![CDATA[
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
		
			if (!$forum_user['is_guest'])
			{
				$forum_page['post_actions']['reply'] = '<span class="edit-post first-item" style="display: none"><a href="#" onclick="Reply('.$id. ','.$cur_post['id'].', this); return false;">'.$lang_pun_quote['Reply'].'<span>&#160;'.$lang_topic['Post'].' '.($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';
				unset($forum_page['post_actions']['quote']);
				$forum_page['post_actions']['quote'] = '<span class="edit-post first-item"><a href="'.forum_link($forum_url['quote'], array($id, $cur_post['id'])).'" onclick="QuickQuote('.$id. ','.$cur_post['id'].', this); return false;">'.$lang_pun_quote['Quote'].'<span>&#160;'.$lang_topic['Post'].' '.($forum_page['start_from'] + $forum_page['item_count']).'</span></a></span>';
			}
		]]></hook>


		<hook id="co_common"><![CDATA[
			$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));
		]]></hook>

		<hook id="ft_about_end" priority="10"><![CDATA[
			if (!defined('PUN_EXTENSIONS_USED') && !empty($pun_extensions_used))
			{
				define('PUN_EXTENSIONS_USED', 1);
				echo '<p id="extensions-used">Currently used extensions: '.implode(', ', $pun_extensions_used).'. Copyright &copy; 2008 <a href="http://punbb.informer.com/">PunBB</a></p>';
			}
		]]></hook>
	</hooks>
</extension>