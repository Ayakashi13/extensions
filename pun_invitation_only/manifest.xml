<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

	Copyright (C) 2008  PunBB

	PunBB is free software; you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 2 of the License,
	or (at your option) any later version.

	PunBB is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston,
	MA  02111-1307  USA

***********************************************************************
-->

<extension engine="1.0">
	<id>pun_invitation_only</id>
	<title>Invitation of new users</title>
	<version>1.0.0</version>
	<description>Allows to invite new users to register on a forum </description>
	<author>PunBB Development Team</author>
	<minversion>1.3</minversion>
	<maxtestedon>1.3.4</maxtestedon>

		<install><![CDATA[

			if(!$forum_db->table_exists('pun_invitations_only'))
			{
				$schema = array(
					'FIELDS'=> array(

						'inviter_id'=>array(
							'datatype' =>  'INT(10) UNSIGNED',
							'allow_null' => false
						),

						'invitee_code'=>array(
							'datatype'		=> 'VARCHAR(32)',
							'allow_null'	=> false
						),

						'invitee_email' => array(
							'datatype'		=> 'VARCHAR(80)',
							'allow_null'	=> false,
							'default'		=> '\'\''
						),

						'created' => array(
							'datatype'		=> 'INT(10) UNSIGNED',
							'allow_null'	=> false,
							'default'		=> '0'
						),

						'used' => array(
							'datatype'		=> 'INT(10) UNSIGNED',
							'allow_null'	=> false,
							'default'		=> '0'
						),
					),
					'INDEXES'		=> array(
						'id_email_idx'	=> array('inviter_id','invitee_email'),
						'code_email_idx'	=> array('invitee_code', 'invitee_email')
					)
				);

				$forum_db->create_table('pun_invitations_only', $schema);
			}

			if (!$forum_db->field_exists('groups', 'g_allow_invite'))
		$forum_db->add_field('groups', 'g_allow_invite', 'INT(3)', false, '0');


			$query_inv_sys = array(
			'SELECT'	=>	'1',
			'FROM'		=>	'config',
			'WHERE'		=>	'conf_name="o_invite_system"'
			);
			$result_inv_sys = $forum_db->query_build($query_inv_sys) or error(__FILE__, __LINE__);

			if (!$forum_db->num_rows($result_inv_sys))
			{
		$query_inv_sys = array(
			'INSERT'	=> 'conf_name, conf_value',
			'INTO'		=> 'config',
			'VALUES'	=> '"o_invite_system", "0"'
		);

		$forum_db->query_build($query_inv_sys) or error(__FILE__, __LINE__);
			}


		]]></install>

		<uninstall><![CDATA[
			$forum_db->drop_table('pun_invitations_only');
			$forum_db->drop_field('groups', 'g_allow_invite');

			$query_inv_sys = array(
		'DELETE'	=> 'config',
		'WHERE'		=> 'conf_name="o_invite_system"'
			);
			$forum_db->query_build($query_inv_sys) or error(__FILE__, __LINE__);
		]]></uninstall>

	<hooks>


        <hook id="co_common"><![CDATA[

		//$forum_url['admin_extensions_approvalpost'] = 'admin/extensions.php?section=approvalpost';

		if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
			require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
		else
			require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
		require $ext_info['path'].'/functions.php';

		$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));

	]]></hook>


	<!--This hook is used to add a hyperlink "Show unapproved posts" to the right top corner (forum header) -->
	<hook id="hd_visit_elements"><![CDATA[
		if ($forum_user['g_id'] == FORUM_ADMIN || $forum_user['g_allow_invite']=='1')
		{
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

			require $ext_info['path'].'/inv_sys_url.php';

			$visit_links[] = '<span id="invite"'.(empty($visit_links) ? ' class="first-item"' : '').'><a href="'.forum_link($inv_sys_url['Section']).'">'.$lang_inv_sys['Send new invitation'].' </a></span>';
			$visit_elements['<!-- forum_visit -->'] = '<p id="visit-links" class="options">'.implode(' ', $visit_links).'</p>';
		}
	]]></hook>




	<!--Adds information to the forum footer-->
	<hook id="ft_about_end" priority="10"><![CDATA[

			if (!defined('PUN_EXTENSIONS_USED') && !empty($pun_extensions_used))
			{
					define('PUN_EXTENSIONS_USED', 1);
					echo '<p id="extensions-used">Currently used extensions: '.implode(', ', $pun_extensions_used).'. Copyright &copy; 2009 <a href="http://punbb.informer.com/">PunBB</a></p>';
			}
	]]></hook>


	<!-- Hook for administration/settings/features page. Makes language definitions of the extension available on yhe page.-->
	<hook id="aop_features_pre_header_load"><![CDATA[
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
	]]></hook>



	<!--Adds checkbox to administration/settings/features page-->
	<hook id="aop_features_avatars_fieldset_end"><![CDATA[
										?>
						<div class="content-head">
							<h2 class="hn"><span><?php echo $lang_inv_sys['Title'] ?></span></h2>
			</div>
			<fieldset class="frm-group group1">
				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
					<div class="sf-box checkbox">
						<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="form[invite_system]" value="1"<?php if ($forum_config['o_invite_system'] == '1') echo ' checked="checked"' ?> /></span>
						<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_inv_sys['Enable inv title'] ?></span> <?php echo $lang_inv_sys['Enable inv'] ?></label>
					</div>
				</div>
			</fieldset>
						<?php
				]]></hook>



	<!--In case checbox is not checked, this hook adds zero value to the vriable responsible for that checkbox.-->
	<hook id="aop_features_validation"><![CDATA[
			if (!isset($form['invite_system']) || $form['invite_system'] != '1') $form['invite_system'] = '0';
	]]></hook>


	<!-- Adds checkboxes to administration/Groups in order to allow certain groups snred invitations t their friends-->
	<hook id="agr_add_edit_group_user_permissions_fieldset_end"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			?>
				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?>">
					<legend><span><?php echo $lang_inv_sys['Title'] ?></span></legend>
					<div class="mf-box">
						<div class="mf-item">
							<span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="allow_invite" value="1"<?php if ($group['g_allow_invite'] == '1') echo ' checked="checked"' ?> /></span>
							<label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo $lang_inv_sys['Allow invite others'] ?></label>
						</div>
					</div>
				</fieldset>
			<?php
		]]></hook>

	<!--Adds values of the checkboxes on administration/groups page to the query, executed when the page is being submitted-->
	<hook id="agr_edit_end_qr_update_group"><![CDATA[
			$allow_invite = isset($_POST['allow_invite']) ? intval($_POST['allow_invite']) : '0';
			$query['SET'] .= ', g_allow_invite='.$allow_invite;

	]]></hook>


	<hook id="re_rewrite_rules"><![CDATA[
		// $forum_rewrite_rules['/^invite(\.php?|\/)?(.html?|\/)?$/i'] = 'misc.php?action=news';
	]]></hook>

	<hook id="aex_new_action" ><![CDATA[
		echo 'INSIDE HOOK';
		require FORUM_ROOT.'lang/'.$forum_user['language'].'/admin_common.php';
		if($forum_user['g_id'] == FORUM_ADMIN || $forum_user['g_allow_invite']=='1')
		{
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
			require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
				else
			require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			require $ext_info['path'].'/inv_sys_url.php';
			$section = isset($_GET['section']) ? $_GET['section'] : null;
			echo $section;
			if($section =='invitation')
			{
				// Setup breadcrumbs
				$forum_page['crumbs'] = array(
				array($forum_config['o_board_title'], forum_link($forum_url['index'])),
				$lang_inv_sys['Invite']
				);
				send_invitation();
				define('FORUM_PAGE_SECTION', 'invitations');
				define('FORUM_PAGE', 'invite_new_user');
				require FORUM_ROOT.'header.php';

				ob_start();
				show_invitation_form();
				$tpl_app_post = trim(ob_get_contents());
				$tpl_main = str_replace('<!-- forum_main -->', $tpl_app_post, $tpl_main);

				ob_end_clean();
				require FORUM_ROOT.'footer.php';
			}	

		}
	]]>


</hooks>
</extension>
