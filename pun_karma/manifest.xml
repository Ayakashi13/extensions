<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

	Copyright (C) 2008  PunBB

	PunBB is free software; you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 2 of the License,
	or (at your option) any later version.

	PunBB is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston,
	MA  02111-1307  USA

***********************************************************************
-->

<extension engine="1.0">
	<id>pun_karma</id>
	<title>Post karma</title>
	<version>1.0b.1</version>
	<description>Adds karma/reputation to posts.</description>
	<author>PunBB Development Team</author>
	<minversion>1.3 Beta</minversion>
	<maxtestedon>1.3 Beta</maxtestedon>

	<install><![CDATA[
if (!$forum_db->table_exists('pun_karma'))
{
	$schema = array(
		'FIELDS'	=> array(
			'user_id'	=>	array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false
			),
			'post_id'	=>	array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false
			),
			'mark' => array(
				'datatype'		=> 'TINYINT(1)',
				'allow_null'	=> false
			),
			'updated_at'	=>	array(
				'datatype'		=> 'INT(10) UNSIGNED',
				'allow_null'	=> false
			)
		),
		'PRIMARY KEY'	=> array('user_id', 'post_id'),
		'INDEXES'		=> array('karmapost_idx' => array('post_id'))
	);
	$forum_db->create_table('pun_karma', $schema);
}
$forum_db->add_field('posts', 'karma', 'INT(10)', TRUE);
	]]></install>

	<uninstall><![CDATA[
$forum_db->drop_table('pun_karma');
$forum_db->drop_field('posts', 'karma');
	]]></uninstall>

	<hooks>
		<hook id="re_rewrite_rules"><![CDATA[
$forum_rewrite_rules['/^post[\/_-]([0-9]+)[\/_-]karma(plus|minus|cancel)(\.html?|\/)?$/i'] = 'viewtopic.php?pid=$1&karma$2';
		]]></hook>
		<hook id="vt_qr_get_posts"><![CDATA[
$query['SELECT'] .= ', p.karma';
$pun_karma_posts = array();
$pun_karma_authors = array();
		]]></hook>
		<hook id="vt_modify_topic_info"><![CDATA[
require $ext_info['path'].'/functions.php';
if (!$forum_user['is_guest'] && (isset($_GET['karmaplus']) || isset($_GET['karmaminus']) || isset($_GET['karmacancel'])))
{
	if (isset($_GET['karmaplus']))
		karma_plus($pid);
	else if (isset($_GET['karmaminus']))
		karma_minus($pid);
	else if (isset($_GET['karmacancel']))
		karma_cancel($pid);
}
		]]></hook>
		<hook id="vt_pre_header_load"><![CDATA[
//Including lang file
if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
	require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
else
	require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
require $ext_info['path'].'/url/'.$forum_config['o_sef'].'/forum_urls.php';
		]]></hook>
		<hook id="vt_post_loop_start"><![CDATA[
$pun_karma_posts[$cur_post['id']] = $cur_post['karma'];
$pun_karma_authors[$cur_post['id']] = $cur_post['poster_id'];
		]]></hook>
		<hook id="vt_row_pre_display"><![CDATA[
$forum_page['post_options']['karma'] = '<p class="post-karma">'.$cur_post['id'].'</p>';
		]]></hook>
		<hook id="vt_end"><![CDATA[
$pun_karma_query = array(
	'SELECT'	=>	'post_id',
	'FROM'		=>	'pun_karma',
	'WHERE'		=>	'user_id = '.$forum_user['id'].' AND post_id IN ('.implode(',', array_keys($pun_karma_posts)).')'
);
$pun_karma_result = $forum_db->query_build($pun_karma_query) or error(__FILE__, __LINE__);

$user_karma_posts = array();
if ($forum_db->num_rows($pun_karma_result) > 0)
{
	while ($cur_id = $forum_db->fetch_assoc($pun_karma_result))
		$user_karma_posts[] = $cur_id['post_id'];
}

$buffer = forum_trim(ob_get_contents());
$karma_matches = array();
preg_match_all('~<p class="post-karma">([0-9]+)</p>~', $buffer, $karma_matches);
foreach ($karma_matches[0] as $match_index => $match_string)
{
	$post_karma = '';
	if (!is_null($pun_karma_posts[$karma_matches[1][$match_index]]))
		$post_karma = '<strong>'.($pun_karma_posts[$karma_matches[1][$match_index]] === '0' ? '0' : ($pun_karma_posts[$karma_matches[1][$match_index]] > 0 ? '+' : '&minus;').abs($pun_karma_posts[$karma_matches[1][$match_index]])).'</strong>';
	//Is user author of post?
	if ($pun_karma_authors[$karma_matches[1][$match_index]] == $forum_user['id'])
		$post_karma = '<p class="post-karma">'.$post_karma.'</p>';		
	else
	{
		//User vote for this post?
		if (in_array($karma_matches[1][$match_index], $user_karma_posts))
			$post_karma = '<p class="post-karma">'.$post_karma.' <a href="'.forum_link($forum_url['karmacancel'], array($karma_matches[1][$match_index])).'">'.$lang_pun_karma['Cancel mark'].'</a></p>';
		else
			$post_karma = '<p class="post-karma"><a href="'.forum_link($forum_url['karmaplus'], array($karma_matches[1][$match_index])).'">'.$lang_pun_karma['Plus mark'].'</a> '.$post_karma.' <a href="'.forum_link($forum_url['karmaminus'], array($karma_matches[1][$match_index])).'">'.$lang_pun_karma['Minus mark'].'</a></p>';
	}
	$buffer = str_replace($match_string, $post_karma, $buffer);
}
$tpl_main = str_replace('<!-- forum_main -->', $buffer, $tpl_main);
		]]></hook>
		<hook id="dl_form_submitted"><![CDATA[
require_once $ext_info['path'].'/functions.php';
if (isset($_POST['req_confirm']))
	if ($cur_post['is_topic'])
		delete_topic_karma( $cur_post['tid'] );
	else
		delete_post_karma( $id );
		]]></hook>
	</hooks>
</extension>
