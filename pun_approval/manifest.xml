<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

	Copyright (C) 2008  PunBB

	PunBB is free software; you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 2 of the License,
	or (at your option) any later version.

	PunBB is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston,
	MA  02111-1307  USA

***********************************************************************
-->

<extension engine="1.0">
	<id>pun_approval</id>
	<title>Post approval</title>
	<version>0.7</version>
	<description>Pun approval extension</description>
	<author>PunBB Development Team</author>
	<minversion>1.3 SVN</minversion>
	<maxtestedon>1.3 SVN</maxtestedon>

	<install><![CDATA[
	
		if (!$forum_db->table_exists('post_approval_posts'))
		{
			$schema = array(
				'FIELDS'		=> array(
					'id'			=> array(
						'datatype'		=> 'SERIAL',
						'allow_null'	=> false
					),
					'poster'		=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'poster_id'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '1'
					),
					'poster_ip'		=> array(
						'datatype'		=> 'VARCHAR(39)',
						'allow_null'	=> true
					),
					'poster_email'	=> array(
						'datatype'		=> 'VARCHAR(80)',
						'allow_null'	=> true
					),
					'message'		=> array(
						'datatype'		=> 'TEXT',
						'allow_null'	=> true
					),
					'hide_smilies'	=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'posted'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'edited'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> true
					),
					'edited_by'		=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> true
					),
					'topic_id'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					)
				),
				'PRIMARY KEY'	=> array('id'),
				'INDEXES'		=> array(
					'topic_id_idx'	=> array('topic_id'),
					'multi_idx'		=> array('poster_id', 'topic_id')
				)
			);
			
			$forum_db->create_table('post_approval_posts', $schema);
		}

	if (!$forum_db->table_exists('post_approval_topics'))
	{
		$schema = array(
			'FIELDS'		=> array(
				'id'			=> array(
					'datatype'		=> 'SERIAL',
					'allow_null'	=> false
				),
				'poster'		=> array(
					'datatype'		=> 'VARCHAR(200)',
					'allow_null'	=> false,
					'default'		=> '\'\''
				),
				'subject'		=> array(
					'datatype'		=> 'VARCHAR(255)',
					'allow_null'	=> false,
					'default'		=> '\'\''
				),
				'posted'		=> array(
					'datatype'		=> 'INT(10) UNSIGNED',
					'allow_null'	=> false,
					'default'		=> '0'
				),
				'first_post_id'	=> array(
					'datatype'		=> 'INT(10) UNSIGNED',
					'allow_null'	=> false,
					'default'		=> '0'
				),
				'last_post'		=> array(
					'datatype'		=> 'INT(10) UNSIGNED',
					'allow_null'	=> false,
					'default'		=> '0'
				),
				'last_post_id'	=> array(
					'datatype'		=> 'INT(10) UNSIGNED',
					'allow_null'	=> false,
					'default'		=> '0'
				),
				'last_poster'	=> array(
					'datatype'		=> 'VARCHAR(200)',
					'allow_null'	=> true
				),
				'num_views'		=> array(
					'datatype'		=> 'MEDIUMINT(8) UNSIGNED',
					'allow_null'	=> false,
					'default'		=> '0'
				),
				'num_replies'	=> array(
					'datatype'		=> 'MEDIUMINT(8) UNSIGNED',
					'allow_null'	=> false,
					'default'		=> '0'
				),
				'closed'		=> array(
					'datatype'		=> 'TINYINT(1)',
					'allow_null'	=> false,
					'default'		=> '0'
				),
				'sticky'		=> array(
					'datatype'		=> 'TINYINT(1)',
					'allow_null'	=> false,
					'default'		=> '0'
				),
				'moved_to'		=> array(
					'datatype'		=> 'INT(10) UNSIGNED',
					'allow_null'	=> true
				),
				'forum_id'		=> array(
					'datatype'		=> 'INT(10) UNSIGNED',
					'allow_null'	=> false,
					'default'		=> '0'
				)
			),
			'PRIMARY KEY'	=> array('id'),
			'INDEXES'		=> array(
				'forum_id_idx'		=> array('forum_id'),
				'moved_to_idx'		=> array('moved_to'),
				'last_post_idx'		=> array('last_post'),
				'first_post_id_idx'	=> array('first_post_id')
			)
		);
		
		$forum_db->create_table('post_approval_topics', $schema);
		
		$sql_query = 'INSERT INTO post_approval_topics (id, poster, subject, posted, closed, sticky, forum_id) SELECT id, poster, subject, posted, closed, sticky, forum_id FROM topics';
		
		$forum_db->query($sql_query);
	}
	
	if (!$forum_db->field_exists('forums', 'post_approval'))
		$forum_db->add_field('forums', 'post_approval', 'INT(3)', false, '1');
	
	if (!$forum_db->field_exists('groups', 'g_without_approval'))
		$forum_db->add_field('groups', 'g_without_approval', 'INT(3)', false, '0');
	
	if (!$forum_db->field_exists('posts', 'app_timestamp'))
		$forum_db->add_field('posts', 'app_timestamp', 'INT(10) UNSIGNED', true, '0');
	
	if (!$forum_db->field_exists('posts', 'app_username'))
		$forum_db->add_field('posts', 'app_username', 'VARCHAR(200)', true, '');
	
	]]></install>
	
	<uninstall><![CDATA[
		$forum_db->drop_table('post_approval_posts');
		$forum_db->drop_table('post_approval_topics');
		$forum_db->drop_field('forums', 'post_approval');
		$forum_db->drop_field('groups', 'g_without_approval');
		$forum_db->drop_field('posts', 'app_timestamp');
		$forum_db->drop_field('posts', 'app_username');
	]]></uninstall>

	<hooks>
		
		<hook id="vt_quickpost_pre_fieldset_end"><![CDATA[
			
			$query = array(
				'SELECT'	=>	'post_approval',
				'FROM'		=>	$forum_db->prefix.'topics as t, '.$forum_db->prefix.'forums as f',
				'WHERE'		=>	't.id = '.$id.' AND f.id = t.forum_id',
				'PARAMS'	=>	array('NO_PREFIX' => true)
			);
			$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);
			list($post_approval) = $forum_db->fetch_row($result);
			if (!$forum_user['is_admmod'] && ($post_approval == 1 && $forum_user['g_without_approval'] == 0))
			{
		
				?>
				<div class="frm-info">
					<p><?php echo $lang_app_post['warning'] ?></p>
				</div>
				<?php

			}
			
		]]></hook>
		
		<hook id="vt_qr_get_posts"><![CDATA[
			$query['SELECT'] .= ', g_without_approval';
		]]></hook>
		
		<hook id="po_pre_optional_fieldset"><![CDATA[
			if (!$forum_user['is_admmod'] && ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 0))
			{

				?>
				<div class="frm-info">
					<p><?php echo $lang_app_post['Topic warning'] ?></p>
				</div>
				<?php

			}
		]]></hook>
		
		<hook id="po_pre_redirect"><![CDATA[
			if (isset($approve))
			{
				//if its new post do redirect to previous 
				if ($tid)
				{
					$query = array(
						'SELECT'	=>	'last_post_id',
						'FROM'		=>	'topics',
						'WHERE'		=>	'id = '.$tid
					);
					$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);
					list($last_post_id) = $forum_db->fetch_row($result); 

					redirect(forum_link($forum_url['post'], $last_post_id), 'Your post will be approved (moderated)');
				}	
				else if ($fid)
					redirect(forum_link($forum_url['forum'], $fid), 'Your topic will be approved (moderated)');
			}
		]]></hook>
		
		<hook id="po_pre_add_topic"><![CDATA[
		//If forum no needed post approval or user can post without approval
			if (!$forum_user['is_admmod'] && ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 0))
			{
				$query = array(
					'SELECT'	=> 'num_replies',
					'FROM'		=> 'post_approval_topics'
				);
				
				$res = $forum_db->query_build($query) or error(__FILE__, __LINE__);
				
				$count = $forum_db->fetch_assoc($res);
				
				$query = array(
					'INSERT'	=> 'poster, subject, posted, last_post, last_poster, forum_id, num_replies',
					'INTO'		=> 'post_approval_topics',
					'VALUES'	=> '\''.$forum_db->escape($post_info['poster']).'\', \''.$forum_db->escape($post_info['subject']).'\', '.$post_info['posted'].', '.$post_info['posted'].', \''.$forum_db->escape($post_info['poster']).'\', '.$post_info['forum_id'].', '.($count['num_replies'] + 1)
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				
				$approve = true;
				$new_tid = 0;
				$new_pid = 0;
			}
		]]></hook>
		
		<hook id="po_pre_add_post"><![CDATA[
			//If forum no needed post approval or user can post without approval
			if (!$forum_user['is_admmod'] && ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 0))
			{
				$query = array(
					'INSERT'	=> 'poster, poster_id, poster_ip, message, hide_smilies, posted, topic_id',
					'INTO'		=> 'posts',
					'VALUES'	=> '\''.$forum_db->escape($post_info['poster']).'\', '.$post_info['poster_id'].', \''.get_remote_address().'\', \''.$forum_db->escape($post_info['message']).'\', '.$post_info['hide_smilies'].', '.$post_info['posted'].', '.$post_info['topic_id']
				);
		
				// If it's a guest post, there might be an e-mail address we need to include
				if ($post_info['is_guest'] && $post_info['poster_email'] != null)
				{
					$query['INSERT'] .= ', poster_email';
					$query['VALUES'] .= ', \''.$post_info['poster_email'].'\'';
				}
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				$approve = true;
				$new_pid = 0;
				
				$new_app_pid = $forum_db->insert_id();
				
				$query_app = 'INSERT INTO post_approval_posts (id, poster, poster_id, poster_ip, poster_email, message, hide_smilies, posted, edited, edited_by, topic_id) 
					SELECT p.id, p.poster, p.poster_id, p.poster_ip, p.poster_email, p.message, p.hide_smilies, p.posted, p.edited, p.edited_by, p.topic_id 
					FROM posts AS p 
					WHERE id='.$new_app_pid;
				$forum_db->query($query_app) or error(__FILE__, __LINE__);
				
				$query_app = array(
					'SELECT'	=> 't.id, t.num_replies',
					'FROM'		=> 'post_approval_posts AS p',
					'JOIN'		=> array(
						array(
							'INNER JOIN'	=> 'post_approval_topics AS t',
							'ON'			=> 't.id=t.topic_id'
						)
					),
					'WHERE'		=> 'p.id='.$new_app_pid
				);
				$resour = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$line = array();
				
				if ($forum_db->num_rows($resour))
				{
					$line = $forum_db->fetch_assoc($resour);
					
					$query_app = array(
						'UPDATE'	=> 'post_approval_topics',
						'SET'		=> 'last_post_id='.$new_app_pid.', num_replies='.(intval($line['num_replies']) + 1),
						'WHERE'		=> 'id='.$line['id']
					);
					
					$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				}
				
				$query_app = array(
					'DELETE'	=> 'posts',
					'WHERE'		=> 'id='.$new_app_pid
				);
				
				$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			}
		]]></hook>
		
		<hook id="fn_add_post_start"><![CDATA[
			//If no need to approve posts of this topic or user can post without approval
			global $cur_posting, $forum_user;
			if (!($forum_user['is_admmod'] || ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 1) || $cur_posting['post_approval'] == 0))
				return 1;
		]]></hook>
		
		<hook id="fn_add_topic_start"><![CDATA[
			global $cur_posting, $forum_user;
			//If no need to approve posts of this topic or user can post without approval
			if (!($forum_user['is_admmod'] || ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 1) || $cur_posting['post_approval'] == 0))
				return 1;
		]]></hook>
		
		<hook id="po_qr_get_forum_info"><![CDATA[
			$query['SELECT'] .= ', f.post_approval';
		]]></hook>
		
		<hook id="po_qr_get_topic_forum_info"><![CDATA[
			$query['SELECT'] .= ', f.post_approval';
		]]></hook>
		
		<hook id="ed_qr_update_subject"><![CDATA[
			if (!$forum_user['is_admmod'] && ($cur_post['post_approval'] == 1 && $forum_user['g_without_approval'] == 0))
			{
				$query = array(
					'INSERT'	=> 'poster, subject, posted, last_post, last_poster, forum_id',
					'INTO'		=> 'post_approval_topics',
					'VALUES'	=> '\''.$forum_db->escape($cur_post['poster']).'\', \''.$forum_db->escape($subject).'\', '.$cur_post['posted'].', '.$post_info['posted'].', \''.$forum_db->escape($post_info['poster']).'\', '.$post_info['forum_id']
				);
			}
			$forum_db->query_build($query) or error(__FILE__, __LINE__);
		]]></hook>
		
		<hook id="ed_qr_get_post_info"><![CDATA[
			$query['SELECT'] .= ', f.post_approval';
		]]></hook>

		<hook id="afo_edit_forum_pre_permissions_part"><![CDATA[

			$query_app_post = array(
				'SELECT'	=> 'post_approval',
				'FROM'		=> 'forums',
				'WHERE'		=> 'id='.$forum_id
			);

			$result_app_post = $forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
			$app_post = $forum_db->fetch_assoc($result_app_post);

			?>
				<div class="content-head">
					<h3 class="hn"><span><?php echo $lang_app_post['forum head'] ?></span></h3>
				</div>
				<div class="ct-box">
					<ul>
						<?php echo "\n\t\t\t\t\t".$lang_app_post['forum info']."\n" ?>
					</ul>
				</div>
				<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">
					<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
						<div class="sf-box select">
							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_app_post['name check'] ?></span></label><br />
							<span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="allow_app_post" value="1" <?php echo ($app_post['post_approval'] == 1) ? 'checked' : ''; ?> /><?php echo $lang_app_post['forum check'] ?></span>
						</div>
					</div>
				</fieldset>
				
			<?php

		]]></hook>

		<hook id="afo_save_forum_qr_update_forum"><![CDATA[

			$allow_app_post = isset($_POST['allow_app_post']) ? '1' : '0';
			$query['SET'] .= ', post_approval='.$allow_app_post;

		]]></hook>

		<hook id="agr_add_edit_group_user_permissions_fieldset_end"><![CDATA[

			?>
				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?>">
					<legend><span><?php echo $lang_app_post['legend checks'] ?></span></legend>
					<div class="mf-box">
						<div class="mf-item">
							<span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="without_approval" value="1"<?php if ($group['g_without_approval'] == '1') echo ' checked="checked"' ?> /></span>
							<label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo $lang_app_post['name check'] ?></label>
						</div>
					</div>
				</fieldset>
			<?php

		]]></hook>

		<hook id="agr_edit_end_qr_update_group"><![CDATA[

			$without_approval = isset($_POST['without_approval']) ? intval($_POST['without_approval']) : '0';
			$query['SET'] .= ', g_without_approval='.$without_approval;

		]]></hook>

		<hook id="co_common"><![CDATA[

			$forum_url['admin_extensions_approvalpost'] = 'admin/extensions.php?section=approvalpost';
			
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
            	require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
            else
            	require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			require $ext_info['path'].'/functions.php';
			
			$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));

		]]></hook>
		
		<hook id="ca_fn_generate_admin_menu_new_sublink"><![CDATA[
			
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
		       	require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			require $ext_info['path'].'/post_app_url.php';
		
			if ((FORUM_PAGE_SECTION == 'admin-post_approval') && ($forum_user['g_id'] == FORUM_ADMIN))
			{
				$adnav_sublinks['admin-unapp_posts'] = '<li'.((FORUM_PAGE == 'admin-unapp_posts') ? ' class="isactive"' : '').'><a href="'.forum_link($post_app_url['Posts section']).'">'.$lang_app_post['Unp posts'].'</a></li>';
				$adnav_sublinks['admin-unapp_topics'] = '<li'.((FORUM_PAGE == 'admin-unapp_topics') ? ' class="isactive"' : '').'><a href="'.forum_link($post_app_url['Topics section']).'">'.$lang_app_post['Unp topics'].'</a></li>';
			}
			
		]]></hook>
		
		<hook id="ca_fn_generate_admin_menu_new_link"><![CDATA[
			
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			require $ext_info['path'].'/post_app_url.php';
			
			if ($forum_user['g_id'] == FORUM_ADMIN)
			{
				$adnav_links['post_approval'] = '<li'.((FORUM_PAGE_SECTION == 'admin-post_approval') ? ' class="topactive"' : '').'><a href="'.forum_link($post_app_url['Section']).'"><span>'.$lang_app_post['Title'].'</span></a>'.(((FORUM_PAGE_SECTION == 'admin-post_approval') && ($adnav_submenu != '')) ? $adnav_submenu."\n\t\t\t" : '').'</li>';
			}
			
		]]></hook>
		
		<hook id="aex_new_action"><![CDATA[
			
			if (($section == 'approvalpost') || ($section == 'unapp_posts'))
			{
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
				else
					require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
				require $ext_info['path'].'/post_app_url.php';
				
				$aptid = isset($_GET['aptid']) ? $_GET['aptid'] : 0;
				$pid = isset($_GET['appid']) ? $_GET['appid'] : 0;
				$del = isset($_GET['del']) ? $_GET['del'] : 0;
				$app = isset($_GET['app']) ? $_GET['app'] : 0;
				$topics = isset($_GET['topics']) ? $_GET['topics'] : 0;
				
				// Setup breadcrumbs
				$forum_page['crumbs'] = array(
					array($forum_config['o_board_title'], forum_link($forum_url['index'])),
					array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),
					array($lang_app_post['Unp posts'], forum_link($post_app_url['Section']))
				);
				
				if ($aptid)
					array_push($forum_page['crumbs'], array($lang_app_post['Topics'], forum_link($post_app_url['Section'])));
				
				define('FORUM_PAGE_SECTION', 'unapp_posts');
				define('FORUM_PAGE', 'admin-unapp_posts-approvalpost');
				require FORUM_ROOT.'header.php';
				
				ob_start();
				
				show_unapproved_posts();
				
				$tpl_app_post = trim(ob_get_contents());
				$tpl_main = str_replace('<!-- forum_main -->', $tpl_app_post, $tpl_main);
				
				ob_end_clean();
				
				require FORUM_ROOT.'footer.php';
			}

		]]></hook>

		<hook id="ft_about_end" priority="10"><![CDATA[
			
			if (!defined('PUN_EXTENSIONS_USED') && !empty($pun_extensions_used))
			{
				define('PUN_EXTENSIONS_USED', 1);
				echo '<p id="extensions-used">Currently used extensions: '.implode(', ', $pun_extensions_used).'. Copyright &copy; 2008 <a href="http://punbb.informer.com/">PunBB</a></p>';
			}
			
		]]></hook>
		
		<hook id="hd_visit_elements"><![CDATA[
			
			if ($forum_user['is_admmod'])
			{
				$forum_url['admin_extensions_approvalpost'] = 'admin/extensions.php?section=approvalpost';
				
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
				else
					require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
				
				$query_app = array(
					'SELECT'	=> 'id',
					'FROM'		=> 'post_approval_posts'
				);
				
				$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				if ($forum_db->num_rows($result_app))
					$visit_links[] = '<span id="visit-unapproved"'.(empty($visit_links) ? ' class="first-item"' : '').'><a href="'.forum_link($forum_url['admin_extensions_approvalpost']).'">'.$lang_app_post['show app posts'].' <strong>('.$forum_db->num_rows($result_app).') </strong></a></span>';
				else
					$visit_links[] = '<span id="visit-unapproved"'.(empty($visit_links) ? ' class="first-item"' : '').'><a href="'.forum_link($forum_url['admin_extensions_approvalpost']).'">'.$lang_app_post['show app posts'].'</a></span>';
				
				$visit_elements['<!-- forum_visit -->'] = '<p id="visit-links" class="options">'.implode(' ', $visit_links).'</p>';
			}
			
		]]></hook>
		
	</hooks>
</extension>
