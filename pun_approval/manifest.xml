<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

	Copyright (C) 2008  PunBB

	PunBB is free software; you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 2 of the License,
	or (at your option) any later version.

	PunBB is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston,
	MA  02111-1307  USA

***********************************************************************
-->

<extension engine="1.0">
	<id>pun_approval_new</id>
	<title>Post approval NEW!!!!</title>
	<version>0.8</version>
	<description>Pun approval extension</description>
	<author>PunBB Development Team</author>
	<minversion>1.3 SVN</minversion>
	<maxtestedon>1.3 SVN</maxtestedon>

<install><![CDATA[

		if (!$forum_db->table_exists('post_approval_users'))
		{
			$schema = array(
				'FIELDS'		=> array(
					'id'				=> array(
						'datatype'		=> 'SERIAL',
						'allow_null'	=> false
					),
					'group_id'			=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '3'
					),
					'username'			=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'password'			=> array(
						'datatype'		=> 'VARCHAR(40)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'salt'				=> array(
						'datatype'		=> 'VARCHAR(12)',
						'allow_null'	=> true
					),
					'email'				=> array(
						'datatype'		=> 'VARCHAR(80)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'email_setting'		=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '1'
					),
					'timezone'			=> array(
						'datatype'		=> 'FLOAT',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'dst'				=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'language'			=> array(
						'datatype'		=> 'VARCHAR(25)',
						'allow_null'	=> false,
						'default'		=> '\'English\''
					),
					'style'				=> array(
						'datatype'		=> 'VARCHAR(25)',
						'allow_null'	=> false,
						'default'		=> '\'Oxygen\''
					),
					'registered'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'registration_ip'	=> array(
						'datatype'		=> 'VARCHAR(39)',
						'allow_null'	=> false,
						'default'		=> '\'0.0.0.0\''
					),
					'last_visit'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'activate_key'		=> array(
						'datatype'		=> 'VARCHAR(8)',
						'allow_null'	=> true
					),
				),
				'PRIMARY KEY'	=> array('id'),
				'INDEXES'		=> array(
					'registered_idx'	=> array('registered'),
					'username_idx'		=> array('username')
				)
			);

			$forum_db->create_table('post_approval_users', $schema);
		}

		if (!$forum_db->table_exists('post_approval_posts'))
		{
			$schema = array(
				'FIELDS'		=> array(
					'id'			=> array(
						'datatype'		=> 'SERIAL',
						'allow_null'	=> false
					),
					'poster'		=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'poster_id'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '1'
					),
					'poster_ip'		=> array(
						'datatype'		=> 'VARCHAR(39)',
						'allow_null'	=> true
					),
					'poster_email'	=> array(
						'datatype'		=> 'VARCHAR(80)',
						'allow_null'	=> true
					),
					'message'		=> array(
						'datatype'		=> 'TEXT',
						'allow_null'	=> true
					),
					'hide_smilies'	=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'posted'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'edited'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> true
					),
					'edited_by'		=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> true
					),
					'topic_id'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					)
				),
				'PRIMARY KEY'	=> array('id'),
				'INDEXES'		=> array(
					'topic_id_idx'	=> array('topic_id'),
					'multi_idx'		=> array('poster_id', 'topic_id')
				)
			);

			$forum_db->create_table('post_approval_posts', $schema);
		}

		if (!$forum_db->table_exists('post_approval_topics'))
		{
			$schema = array(
				'FIELDS'		=> array(
					'id'			=> array(
						'datatype'		=> 'SERIAL',
						'allow_null'	=> false
					),
					'poster'		=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'subject'		=> array(
						'datatype'		=> 'VARCHAR(255)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'posted'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'first_post_id'	=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'last_post'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'last_post_id'	=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'last_poster'	=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> true
					),
					'num_views'		=> array(
						'datatype'		=> 'MEDIUMINT(8) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'num_replies'	=> array(
						'datatype'		=> 'MEDIUMINT(8) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'closed'		=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'sticky'		=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'moved_to'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> true
					),
					'forum_id'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					)
				),
				'PRIMARY KEY'	=> array('id'),
				'INDEXES'		=> array(
					'forum_id_idx'		=> array('forum_id'),
					'moved_to_idx'		=> array('moved_to'),
					'last_post_idx'		=> array('last_post'),
					'first_post_id_idx'	=> array('first_post_id')
				)
			);

			$forum_db->create_table('post_approval_topics', $schema);

			$query_app = array(
				'SELECT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
				'FROM'		=> 'topics'
			);

			$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);

			while($cur = $forum_db->fetch_assoc($result_app))
			{
				$query = array(
					'INSERT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
					'INTO'		=> 'post_approval_topics',
					'VALUES'	=> $cur['id'].', \''.$forum_db->escape($cur['poster']).'\', \''.$forum_db->escape($cur['subject']).'\', '.$cur['posted'].', 0, 0, 0, \'\', 0, 0, '.$cur['closed'].', '.$cur['sticky'].', '.(($cur['moved_to'] != '') ? ($cur['moved_to']) : 'NULL').', '.$cur['forum_id']
				);

				$forum_db->query_build($query) or error(__FILE__, __LINE__);
			}
		}

		if (!$forum_db->field_exists('forums', 'post_approval'))
			$forum_db->add_field('forums', 'post_approval', 'INT(3)', false, '1');

		if (!$forum_db->field_exists('groups', 'g_without_approval'))
			$forum_db->add_field('groups', 'g_without_approval', 'INT(3)', false, '0');

                if (!$forum_db->field_exists('groups','g_allow_post_approval'))
                    $forum_db->add_field('groups','g_allow_post_approval','INT(3)', false, '0');

                if(!$forum_db->field_exists('groups','g_allow_reg_approval'))
                    $forum_db->add_field('groups','g_allow_reg_approval','INT(3)',false,'0');

		if (!$forum_db->field_exists('posts', 'app_timestamp'))
			$forum_db->add_field('posts', 'app_timestamp', 'INT(10) UNSIGNED', true, '0');

		if (!$forum_db->field_exists('posts', 'app_username'))
			$forum_db->add_field('posts', 'app_username', 'VARCHAR(200)', true, '');

		$query_app_post = array(
			'SELECT'	=>	'1',
			'FROM'		=>	'config',
			'WHERE'		=>	'conf_name="o_users_check"'
		);
		$result_app_post = $forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);

		if (!$forum_db->num_rows($result_app_post))
		{
			$query_app_post = array(
				'INSERT'	=> 'conf_name, conf_value',
				'INTO'		=> 'config',
				'VALUES'	=> '"o_users_check", "0"'
			);

			$forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
		}

	]]></install>

<uninstall><![CDATA[
                $forum_db->drop_table('post_approval_posts');
		$forum_db->drop_table('post_approval_topics');
                $forum_db->drop_table('post_approval_users');
		$forum_db->drop_field('forums', 'post_approval');
		$forum_db->drop_field('groups', 'g_without_approval');
		$forum_db->drop_field('posts', 'app_timestamp');
		$forum_db->drop_field('posts', 'app_username');

		$query_app_post = array(
			'DELETE'	=> 'config',
			'WHERE'		=> 'conf_name="o_users_check"'
		);

		$forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
	]]></uninstall>

<hooks>
    <!--This hook is used to add a hyperlink "Show unapproved posts" to the right top corner (forum header) -->
    <hook id="hd_visit_elements"><![CDATA[

			if ($forum_user['is_admmod'])
                        {
                            $forum_url['admin_extensions_approvalpost'] = 'admin/extensions.php?section=approvalpost&topics=1';

                            if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php')) //массив для локализации
					require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
				else
					require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

                            require $ext_info['path'].'/post_app_url.php';

                            $query_unapp_posts=array(
                            'SELECT' =>  'id',
                            'FROM'=>    'post_approval_posts'
                            );

                            $result_unapp_posts=$forum_db->query_build($query_unapp_posts) or error(__FILE__,__LINE__);

                            if($forum_db->num_rows($result_unapp_posts))
                                $visit_links[] = '<span id="visit-unapproved"'.(empty($visit_links) ? ' class="first-item"' : '').'><a href="'.forum_link($forum_url['admin_extensions_approvalpost']).'">'.$lang_app_post['show app posts'].' <strong>('.$forum_db->num_rows($result_app).') </strong></a></span>';
                            else
				$visit_links[] = '<span id="visit-unapproved"'.(empty($visit_links) ? ' class="first-item"' : '').'><a href="'.forum_link($forum_url['admin_extensions_approvalpost']).'">'.$lang_app_post['show app posts'].'</a></span>';
                        }
                        $visit_elements['<!-- forum_visit -->'] = '<p id="visit-links" class="options">'.implode(' ', $visit_links).'</p>';

		]]></hook>
    <!--Adds a checkbox to Administration->Start->Forum->Edit page in order to allow user enable or disable post approval for the current forum-->
    <hook id="afo_edit_forum_pre_permissions_part"><![CDATA[

        $query_app_post = array(
				'SELECT'	=> 'post_approval',
				'FROM'		=> 'forums',
				'WHERE'		=> 'id='.$forum_id
			);

			$result_app_post = $forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
			$app_post = $forum_db->fetch_assoc($result_app_post);

			?>
				<div class="content-head">
					<h3 class="hn"><span><?php echo $lang_app_post['forum head'] ?></span></h3>
				</div>
				<div class="ct-box">
					<ul>
						<?php echo "\n\t\t\t\t\t".$lang_app_post['forum info']."\n" ?>
					</ul>
				</div>
				<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">
					<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
						<div class="sf-box select">
							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_app_post['name check'] ?></span></label><br />
							<span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="allow_app_post" value="1" <?php echo ($app_post['post_approval'] == 1) ? 'checked' : ''; ?> /><?php echo $lang_app_post['forum check'] ?></span>
						</div>
					</div>
				</fieldset>

			<?php
    ]]></hook>
    <!--Adds informatiion about post approval to the query which is made at the end of editing Administration->Start->Forum->Edit page when "Submit" button is pressed -->
    <hook id="afo_save_forum_qr_update_forum"><![CDATA[

			$allow_app_post = isset($_POST['allow_app_post']) ? '1' : '0';
			$query['SET'] .= ', post_approval='.$allow_app_post;

		]]></hook>
    <hook id="agr_add_edit_group_user_permissions_fieldset_end"><![CDATA[

			?>
				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?>">
					<legend><span><?php echo $lang_app_post['legend post approval'] ?></span></legend>
					<div class="mf-box">
						<div class="mf-item">
							<span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="without_approval" value="1"<?php if ($group['g_without_approval'] == '1') echo ' checked="checked"' ?> /></span>
							<label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo $lang_app_post['allow without approval'] ?></label>
						</div>
                                                <div class="mf-item">
                                                        <span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="post_approval" value="1"<?php if ($group['g_allow_post_approval']=='1') echo ' checked="checked"' ?>  /></span>
                                                        <label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo $lang_app_post['allow post approval'] ?></label>
                                                </div>
                                                <div class="mf-item">
                                                        <span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="reg_approval" value="1"<?php if ($group['g_allow_reg_approval']=='1') echo ' checked="checked"' ?>  /></span>
                                                        <label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo $lang_app_post['allow reg approval'] ?></label>
                                                </div>
					</div>
				</fieldset>
			<?php

		]]></hook>
    <hook id="agr_edit_end_qr_update_group"><![CDATA[

			$without_approval = isset($_POST['without_approval']) ? intval($_POST['without_approval']) : '0';
			//$query['SET'] .= ', g_without_approval='.$without_approval;
                        $post_approval=isset($_POST['post_approval'])? intval($_POST['post_approval']) : '0';
                        //$query['SET'].=', g_allow_post_approval='.$post_approval;
                        $reg_approval=isset($_POST['reg_approval']) ? intval($_POST['reg_approval']) : '0';
                        //$query['SET'].=',g_allow_reg_approval='.$reg_approval;
                        $query['SET'] .= ', g_without_approval='.$without_approval.',g_allow_post_approval='.$post_approval.',g_allow_reg_approval='.$reg_approval;

		]]></hook>
    <hook id="aop_features_pre_header_load"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

		]]></hook>

    <hook id="aop_features_validation"><![CDATA[

			if (!isset($form['users_check']) || $form['users_check'] != '1') $form['users_check'] = '0';

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

		]]></hook>
    <hook id="aop_features_avatars_fieldset_end"><![CDATA[
                        ?>
                        <div class="content-head">
                            <h2 class="hn"><span><?php echo $lang_app_post['Title'] ?></span></h2>
			</div>
			<fieldset class="frm-group group1">
				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
					<div class="sf-box checkbox">
						<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="form[users_check]" value="1"<?php if ($forum_config['o_users_check'] == '1') echo ' checked="checked"' ?> /></span>
						<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_app_post['users check name'] ?></span> <?php echo $lang_app_post['users check value'] ?></label>
					</div>
				</div>
			</fieldset>
                        <?php
                ]]></hook>

                

</hooks>

</extension>
