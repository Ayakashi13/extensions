<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

	Copyright (C) 2008  PunBB

	PunBB is free software; you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 2 of the License,
	or (at your option) any later version.

	PunBB is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston,
	MA  02111-1307  USA

***********************************************************************
-->

<extension engine="1.0">
	<id>pun_approval</id>
	<title>Post approval</title>
	<version>0.7</version>
	<description>Pun approval extension</description>
	<author>PunBB Development Team</author>
	<minversion>1.3 SVN</minversion>
	<maxtestedon>1.3 SVN</maxtestedon>

	<install><![CDATA[
		
		if (!$forum_db->table_exists('post_approval_users'))
		{
			$schema = array(
				'FIELDS'		=> array(
					'id'				=> array(
						'datatype'		=> 'SERIAL',
						'allow_null'	=> false
					),
					'group_id'			=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '3'
					),
					'username'			=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'password'			=> array(
						'datatype'		=> 'VARCHAR(40)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'salt'				=> array(
						'datatype'		=> 'VARCHAR(12)',
						'allow_null'	=> true
					),
					'email'				=> array(
						'datatype'		=> 'VARCHAR(80)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'email_setting'		=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '1'
					),
					'timezone'			=> array(
						'datatype'		=> 'FLOAT',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'dst'				=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'language'			=> array(
						'datatype'		=> 'VARCHAR(25)',
						'allow_null'	=> false,
						'default'		=> '\'English\''
					),
					'style'				=> array(
						'datatype'		=> 'VARCHAR(25)',
						'allow_null'	=> false,
						'default'		=> '\'Oxygen\''
					),
					'registered'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'registration_ip'	=> array(
						'datatype'		=> 'VARCHAR(39)',
						'allow_null'	=> false,
						'default'		=> '\'0.0.0.0\''
					),
					'last_visit'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'activate_key'		=> array(
						'datatype'		=> 'VARCHAR(8)',
						'allow_null'	=> true
					),
				),
				'PRIMARY KEY'	=> array('id'),
				'INDEXES'		=> array(
					'registered_idx'	=> array('registered'),
					'username_idx'		=> array('username')
				)
			);
			
			$forum_db->create_table('post_approval_users', $schema);
		}
		
		if (!$forum_db->table_exists('post_approval_posts'))
		{
			$schema = array(
				'FIELDS'		=> array(
					'id'			=> array(
						'datatype'		=> 'SERIAL',
						'allow_null'	=> false
					),
					'poster'		=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'poster_id'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '1'
					),
					'poster_ip'		=> array(
						'datatype'		=> 'VARCHAR(39)',
						'allow_null'	=> true
					),
					'poster_email'	=> array(
						'datatype'		=> 'VARCHAR(80)',
						'allow_null'	=> true
					),
					'message'		=> array(
						'datatype'		=> 'TEXT',
						'allow_null'	=> true
					),
					'hide_smilies'	=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'posted'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'edited'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> true
					),
					'edited_by'		=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> true
					),
					'topic_id'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					)
				),
				'PRIMARY KEY'	=> array('id'),
				'INDEXES'		=> array(
					'topic_id_idx'	=> array('topic_id'),
					'multi_idx'		=> array('poster_id', 'topic_id')
				)
			);
			
			$forum_db->create_table('post_approval_posts', $schema);
		}

		if (!$forum_db->table_exists('post_approval_topics'))
		{
			$schema = array(
				'FIELDS'		=> array(
					'id'			=> array(
						'datatype'		=> 'SERIAL',
						'allow_null'	=> false
					),
					'poster'		=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'subject'		=> array(
						'datatype'		=> 'VARCHAR(255)',
						'allow_null'	=> false,
						'default'		=> '\'\''
					),
					'posted'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'first_post_id'	=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'last_post'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'last_post_id'	=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'last_poster'	=> array(
						'datatype'		=> 'VARCHAR(200)',
						'allow_null'	=> true
					),
					'num_views'		=> array(
						'datatype'		=> 'MEDIUMINT(8) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'num_replies'	=> array(
						'datatype'		=> 'MEDIUMINT(8) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'closed'		=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'sticky'		=> array(
						'datatype'		=> 'TINYINT(1)',
						'allow_null'	=> false,
						'default'		=> '0'
					),
					'moved_to'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> true
					),
					'forum_id'		=> array(
						'datatype'		=> 'INT(10) UNSIGNED',
						'allow_null'	=> false,
						'default'		=> '0'
					)
				),
				'PRIMARY KEY'	=> array('id'),
				'INDEXES'		=> array(
					'forum_id_idx'		=> array('forum_id'),
					'moved_to_idx'		=> array('moved_to'),
					'last_post_idx'		=> array('last_post'),
					'first_post_id_idx'	=> array('first_post_id')
				)
			);
			
			$forum_db->create_table('post_approval_topics', $schema);
			
			$query_app = array(
				'SELECT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
				'FROM'		=> 'topics'
			);
			
			$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			
			while($cur = $forum_db->fetch_assoc($result_app))
			{
				$query = array(
					'INSERT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
					'INTO'		=> 'post_approval_topics',
					'VALUES'	=> $cur['id'].', \''.$forum_db->escape($cur['poster']).'\', \''.$forum_db->escape($cur['subject']).'\', '.$cur['posted'].', '.$cur['first_post_id'].', '.$cur['last_post'].', '.$cur['last_post_id'].', \''.$forum_db->escape($cur['last_poster']).'\', '.$cur['num_views'].', '.$cur['num_replies'].', '.$cur['closed'].', '.$cur['sticky'].', '.((!empty($cur['moved_to'])) ? ($cur['moved_to']) : 0).', '.$cur['forum_id']
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
			}
		}
		
		if (!$forum_db->field_exists('forums', 'post_approval'))
			$forum_db->add_field('forums', 'post_approval', 'INT(3)', false, '1');
		
		if (!$forum_db->field_exists('groups', 'g_without_approval'))
			$forum_db->add_field('groups', 'g_without_approval', 'INT(3)', false, '0');
		
		if (!$forum_db->field_exists('posts', 'app_timestamp'))
			$forum_db->add_field('posts', 'app_timestamp', 'INT(10) UNSIGNED', true, '0');
		
		if (!$forum_db->field_exists('posts', 'app_username'))
			$forum_db->add_field('posts', 'app_username', 'VARCHAR(200)', true, '');
		
		$query_app_post = array(
			'SELECT'	=>	'1',
			'FROM'		=>	'config',
			'WHERE'		=>	'conf_name="o_users_check"'
		);
		$result_app_post = $forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);

		if (!$forum_db->num_rows($result_app_post))
		{
			$query_app_post = array(
				'INSERT'	=> 'conf_name, conf_value',
				'INTO'		=> 'config',
				'VALUES'	=> '"o_users_check", "0"'
			);

			$forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
		}
		
	]]></install>
	
	<uninstall><![CDATA[
		$forum_db->drop_table('post_approval_posts');
		$forum_db->drop_table('post_approval_topics');
		$forum_db->drop_field('forums', 'post_approval');
		$forum_db->drop_field('groups', 'g_without_approval');
		$forum_db->drop_field('posts', 'app_timestamp');
		$forum_db->drop_field('posts', 'app_username');
		
		$query_app_post = array(
			'DELETE'	=> 'config',
			'WHERE'		=> 'conf_name="o_users_check"'
		);
		
		$forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
	]]></uninstall>

	<hooks>
		
		<hook id="fn_add_user_start"><![CDATA[
			
			if ($forum_config['o_users_check'])
			{
				// Add the user
				$query = array(
					'INSERT'	=> 'username, group_id, password, email, email_setting, timezone, dst, language, style, registered, registration_ip, last_visit, salt, activate_key',
					'INTO'		=> 'users',
					'VALUES'	=> '\''.$forum_db->escape($user_info['username']).'\', '.$user_info['group_id'].', \''.$forum_db->escape($user_info['password_hash']).'\', \''.$forum_db->escape($user_info['email']).'\', '.$user_info['email_setting'].', '.floatval($user_info['timezone']).', '.$user_info['dst'].', \''.$forum_db->escape($user_info['language']).'\', \''.$forum_db->escape($user_info['style']).'\', '.$user_info['registered'].', \''.$forum_db->escape($user_info['registration_ip']).'\', '.$user_info['registered'].', \''.$forum_db->escape($user_info['salt']).'\', '.$user_info['activate_key'].''
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				$new_uid = $forum_db->insert_id();
				
				/*
				$query_app = 'INSERT INTO '.$forum_db->prefix.'post_approval_users (username, group_id, password, email, email_setting, timezone, dst, language, style, registered, registration_ip, last_visit, salt, activate_key)
					SELECT u.username, u.group_id, u.password, u.email, u.email_setting, u.timezone, u.dst, u.language, u.style, u.registered, u.registration_ip, u.last_visit, u.salt, u.activate_key
					FROM '.$forum_db->prefix.'users AS u
					WHERE u.id='.$new_uid;
				$forum_db->query($query_app) or error(__FILE__, __LINE__);
				*/
				
				$query_app = array(
					'SELECT'	=> 'id, username, group_id, password, email, email_setting, timezone, dst, language, style, registered, registration_ip, last_visit, salt, activate_key',
					'FROM'		=> 'users',
					'WHERE'		=> 'id='.$new_uid
				);
				
				$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$cur = $forum_db->fetch_assoc($result_app);
				
				$query = array(
					'INSERT'	=> 'id, username, group_id, password, email, email_setting, timezone, dst, language, style, registered, registration_ip, last_visit, salt, activate_key',
					'INTO'		=> 'post_approval_users',
					'VALUES'	=> $new_uid.', \''.$forum_db->escape($cur['username']).'\', '.$cur['group_id'].', \''.$forum_db->escape($cur['password']).'\', \''.$forum_db->escape($cur['email']).'\', '.$cur['email_setting'].', '.floatval($cur['timezone']).', '.$cur['dst'].', \''.$forum_db->escape($cur['language']).'\', \''.$forum_db->escape($cur['style']).'\', '.$cur['registered'].', \''.$forum_db->escape($cur['registration_ip']).'\', '.$cur['last_visit'].', \''.$forum_db->escape($cur['salt']).'\', \''.$cur['activate_key'].'\''
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				
				$query = array(
					'DELETE'	=> 'users',
					'WHERE'		=> 'id='.$new_uid
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				
				return true;
			}
			
		]]></hook>
		<hook id="fn_add_user_qr_insert_user"><![CDATA[
			
			if ($forum_config['o_users_check'])
				$query['INTO'] = 'post_approval_users';
			
		]]></hook>
		
		<hook id="vt_quickpost_pre_fieldset_end"><![CDATA[
			
			$query = array(
				'SELECT'	=>	'post_approval',
				'FROM'		=>	$forum_db->prefix.'topics as t, '.$forum_db->prefix.'forums as f',
				'WHERE'		=>	't.id = '.$id.' AND f.id = t.forum_id',
				'PARAMS'	=>	array('NO_PREFIX' => true)
			);
			$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);
			list($post_approval) = $forum_db->fetch_row($result);
			
			if (!$forum_user['is_admmod'] && ($post_approval == 1 && $forum_user['g_without_approval'] == 0))
			{
				
				?>
				
				<div class="frm-info">
					<p><?php echo $lang_app_post['warning'] ?></p>
				</div>
				
				<?php
				
			}
			
		]]></hook>
		
		<hook id="vt_qr_get_posts"><![CDATA[
			$query['SELECT'] .= ', g_without_approval';
		]]></hook>
		
		<hook id="po_pre_optional_fieldset"><![CDATA[
			if (!$forum_user['is_admmod'] && ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 0))
			{

				?>
				<div class="frm-info">
					<p><?php echo $lang_app_post['Topic warning'] ?></p>
				</div>
				<?php

			}
		]]></hook>
		
		<hook id="po_pre_redirect"><![CDATA[
			if (isset($approve))
			{
				//if its new post do redirect to previous 
				if ($tid)
				{
					$query = array(
						'SELECT'	=>	'last_post_id',
						'FROM'		=>	'topics',
						'WHERE'		=>	'id = '.$tid
					);
					$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);
					list($last_post_id) = $forum_db->fetch_row($result); 

					redirect(forum_link($forum_url['post'], $last_post_id), 'Your post will be approved (moderated)');
				}	
				else if ($fid)
					redirect(forum_link($forum_url['forum'], $fid), 'Your topic will be approved (moderated)');
			}
		]]></hook>
		
		<hook id="po_pre_add_topic"><![CDATA[
			
			//If forum no needed post approval or user can post without approval
			if (!$forum_user['is_admmod'] && ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 0))
			{
				// Create the topic
				$query = array(
					'INSERT'	=> 'poster, subject, posted, last_post, last_poster, forum_id',
					'INTO'		=> 'topics',
					'VALUES'	=> '\''.$forum_db->escape($post_info['poster']).'\', \''.$forum_db->escape($post_info['subject']).'\', '.$post_info['posted'].', '.$post_info['posted'].', \''.$forum_db->escape($post_info['poster']).'\', '.$post_info['forum_id']
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				$new_tid = $forum_db->insert_id(); // number ID of topic
				
				// Create the post ("topic post")
				$query = array(
					'INSERT'	=> 'poster, poster_id, poster_ip, message, hide_smilies, posted, topic_id',
					'INTO'		=> 'posts',
					'VALUES'	=> '\''.$forum_db->escape($post_info['poster']).'\', '.$post_info['poster_id'].', \''.$forum_db->escape(get_remote_address()).'\', \''.$forum_db->escape($post_info['message']).'\', '.$post_info['hide_smilies'].', '.$post_info['posted'].', '.$new_tid
				);

				// If it's a guest post, there might be an e-mail address we need to include
				if ($post_info['is_guest'] && $post_info['poster_email'] != null)
				{
					$query['INSERT'] .= ', poster_email';
					$query['VALUES'] .= ', \''.$forum_db->escape($post_info['poster_email']).'\'';
				}
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				$new_pid = $forum_db->insert_id(); // number ID of post
				
				$query_app = array(
					'SELECT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
					'FROM'		=> 'topics',
					'WHERE'		=> 'id='.$new_tid
				);
				
				$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$cur = $forum_db->fetch_assoc($result_app);
				
				$query = array(
					'INSERT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
					'INTO'		=> 'post_approval_topics',
					'VALUES'	=> $new_tid.', \''.$forum_db->escape($cur['poster']).'\', \''.$forum_db->escape($cur['subject']).'\', '.$cur['posted'].', '.$cur['first_post_id'].', '.$cur['last_post_id'].', \''.$forum_db->escape($cur['last_poster']).'\', '.$cur['num_views'].', '.$cur['num_replies'].', '.$cur['closed'].', '.$cur['sticky'].', '.$cur['moved_to'].', '.$cur['forum_id']
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				
				$query_app = array(
					'SELECT'	=> 'id, poster, poster_id, poster_ip, poster_email, message, hide_smilies, posted, edited, edited_by, topic_id',
					'FROM'		=> 'posts',
					'WHERE'		=> 'id='.$new_pid
				);
				
				$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$cur = $forum_db->fetch_assoc($result_app);
				
				$query = array(
					'INSERT'	=> 'id, poster, poster_id, poster_ip, poster_email, message, hide_smilies, posted, edited, edited_by, topic_id',
					'INTO'		=> 'post_approval_posts',
					'VALUES'	=> $new_pid.', \''.$forum_db->escape($cur['poster']).'\', '.$cur['poster_id'].', \''.$forum_db->escape($cur['poster_ip']).'\', \''.$forum_db->escape($cur['poster_email']).'\', \''.$forum_db->escape($cur['message']).'\', '.$cur['hide_smilies'].', '.$cur['posted'].', '.$cur['edited'].', \''.$forum_db->escape($cur['edited_by']).'\', '.$cur['topic_id']
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				
				$query_app = array(
					'SELECT'	=> 'p.poster, p.posted, t.subject, t.forum_id',
					'FROM'		=> 'post_approval_posts AS p',
					'JOINS'		=> array(
						array(
							'INNER JOIN'	=> 'post_approval_topics AS t',
							'ON'			=> 't.id=p.topic_id',
						),
					),
					'WHERE'		=> 'p.id='.$new_pid
				);
				
				$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				$res_posts = $forum_db->fetch_assoc($result_app);
				
				$query_app = array(
					'UPDATE'	=> 'post_approval_topics',
					'SET'		=> 'subject=\''.$forum_db->escape($res_posts['subject']).' (been approving)\', first_post_id='.$new_pid.', last_post_id='.$new_pid.', last_post='.$res_posts['posted'],
					'WHERE'		=> 'id='.$new_tid
				);
				
				$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$query_app = array(
					'DELETE'	=> 'posts',
					'WHERE'		=> 'id='.$new_pid
				);
				
				$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$query_app = array(
					'DELETE'	=> 'topics',
					'WHERE'		=> 'id='.$new_tid
				);
				
				$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				redirect(forum_link($forum_url['forum'], $res_posts['forum_id']), $lang_app_post['Topic warning']);
			}
			
		]]></hook>
		
		<hook id="po_pre_add_post"><![CDATA[
			//If forum no needed post approval or user can post without approval
			if (!$forum_user['is_admmod'] && ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 0))
			{
				$query = array(
					'INSERT'	=> 'poster, poster_id, poster_ip, message, hide_smilies, posted, topic_id',
					'INTO'		=> 'posts',
					'VALUES'	=> '\''.$forum_db->escape($post_info['poster']).'\', '.$post_info['poster_id'].', \''.get_remote_address().'\', \''.$forum_db->escape($post_info['message']).'\', '.$post_info['hide_smilies'].', '.$post_info['posted'].', '.$post_info['topic_id']
				);
		
				// If it's a guest post, there might be an e-mail address we need to include
				if ($post_info['is_guest'] && $post_info['poster_email'] != null)
				{
					$query['INSERT'] .= ', poster_email';
					$query['VALUES'] .= ', \''.$post_info['poster_email'].'\'';
				}
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				$approve = true;
				$new_pid = 0;
				
				$new_app_pid = $forum_db->insert_id();
				
				$query_app = array(
					'SELECT'	=> 'id, poster, poster_id, poster_ip, poster_email, message, hide_smilies, posted, edited, edited_by, topic_id',
					'FROM'		=> 'posts',
					'WHERE'		=> 'id='.$new_app_pid
				);
				
				$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$cur = $forum_db->fetch_assoc($result_app);
				
				$query = array(
					'INSERT'	=> 'id, poster, poster_id, poster_ip, poster_email, message, hide_smilies, posted, edited, edited_by, topic_id',
					'INTO'		=> 'post_approval_posts',
					'VALUES'	=> $new_app_pid.', \''.$forum_db->escape($cur['poster']).'\', '.$cur['poster_id'].', \''.$forum_db->escape($cur['poster_ip']).'\', \''.$forum_db->escape($cur['poster_email']).'\', \''.$forum_db->escape($cur['message']).'\', '.$cur['hide_smilies'].', '.$cur['posted'].', '.intval($cur['edited']).', \''.$forum_db->escape($cur['edited_by']).'\', '.$cur['topic_id']
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
				
				$query_app = array(
					'SELECT'	=> 't.num_replies, p.posted',
					'FROM'		=> 'post_approval_topics AS t',
					'JOINS'		=> array(
						array(
							'INNER JOIN'	=> 'post_approval_posts AS p',
							'ON'			=> '(p.id='.$new_app_pid.' AND p.topic_id=t.id)',
						),
					),
					'WHERE'		=> 't.id='.$post_info['topic_id']
				);
				$resour = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				if ($forum_db->num_rows($resour))
				{
					$line = $forum_db->fetch_assoc($resour);
					
					$query_app = array(
						'UPDATE'	=> 'post_approval_topics',
						'SET'		=> 'last_post_id='.$new_app_pid.', num_replies='.(intval($line['num_replies']) + 1).', last_post='.$line['posted'],
						'WHERE'		=> 'id='.$post_info['topic_id']
					);
					
					$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				}
				
				$query_app = array(
					'DELETE'	=> 'posts',
					'WHERE'		=> 'id='.$new_app_pid
				);
				
				$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			}
		]]></hook>
		
		<hook id="po_qr_get_forum_info"><![CDATA[
			$query['SELECT'] .= ', f.post_approval';
		]]></hook>
		
		<hook id="po_qr_get_topic_forum_info"><![CDATA[
			$query['SELECT'] .= ', f.post_approval';
		]]></hook>
		
		<hook id="vf_no_results_row_pre_display"><![CDATA[
			
			if (!$forum_user['is_admmod'] && !$forum_user['g_without_approval'])
				$forum_page['item_body']['subject']['approve'] = '<p>'.$lang_app_post['First topic'].'</p>';
			
		]]></hook>
		
		<hook id="fn_qr_update_topic2"><![CDATA[
			
			$query_app_post = $query;
			$query_app_post['UPDATE'] = 'post_approval_topics';
			
			$forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
			
		]]></hook>
		
		<hook id="fn_sync_topic_qr_update_topic"><![CDATA[
			
			$query_app_post = $query;
			
			$query_app_post['UPDATE'] = 'post_approval_topics';
			$forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
			
		]]></hook>
		
		<hook id="mr_confirm_delete_posts_qr_delete_posts"><![CDATA[
			
			$query_app_post = $query;
			
			$query_app_post['DELETE'] = 'post_approval_posts';
			
			$forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
			
		]]></hook>
		
		<hook id="mr_confirm_split_posts_qr_move_posts"><![CDATA[
			
			$query_app = array(
				'SELECT'	=> 'subject',
				'FROM'		=> 'topics',
				'WHERE'		=> 'id='.$new_tid
			);
			
			$res_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			
			$query_app = array(
				'SELECT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
				'FROM'		=> 'topics',
				'WHERE'		=> 'id='.$new_tid
			);
			
			$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			
			$cur = $forum_db->fetch_assoc($result_app);
			
			$query = array(
				'INSERT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
				'INTO'		=> 'post_approval_topics',
				'VALUES'	=> $new_tid.', \''.$forum_db->escape($cur['poster']).'\', \''.$forum_db->escape($cur['subject']).'\', '.$cur['posted'].', '.$cur['first_post_id'].', '.$cur['last_post_id'].', \''.$forum_db->escape($cur['last_poster']).'\', '.$cur['num_views'].', '.$cur['num_replies'].', '.$cur['closed'].', '.$cur['sticky'].', '.$cur['moved_to'].', '.$cur['forum_id']
			);
			
			$forum_db->query_build($query) or error(__FILE__, __LINE__);
			
			if ($forum_db->num_rows($res_app))
			{
				$n_topic = $forum_db->result($res_app);
				
				$query_app = array(
					'UPDATE'	=> 'post_approval_topics',
					'SET'		=> 'subject=\''.$forum_db->escape($n_topic).' (been approving)\'',
					'WHERE'		=> 'id='.$new_tid
				);
				
				$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			}
			
			
			$query_app = array(
				'DELETE'	=> 'topics',
				'WHERE'		=> 'id='.$new_tid
			);
			
			$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			
			
			$query_app = array(
				'UPDATE'	=> 'post_approval_topics',
				'SET'		=> 'first_post_id='.$first_post_data['id'],
				'WHERE'		=> 'id='.$new_tid
			);
			
			$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			
			$query_app = array(
				'SELECT'	=> 'id, poster, poster_id, poster_ip, poster_email, message, hide_smilies, posted, edited, edited_by, topic_id',
				'FROM'		=> 'posts',
				'WHERE'		=> 'id='.$first_post_data['id']
			);
			
			$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			
			$cur = $forum_db->fetch_assoc($result_app);
			
			$query = array(
				'INSERT'	=> 'id, poster, poster_id, poster_ip, poster_email, message, hide_smilies, posted, edited, edited_by, topic_id',
				'INTO'		=> 'post_approval_posts',
				'VALUES'	=> $first_post_data['id'].', \''.$forum_db->escape($cur['poster']).'\', '.$cur['poster_id'].', \''.$forum_db->escape($cur['poster_ip']).'\', \''.$forum_db->escape($cur['poster_email']).'\', \''.$forum_db->escape($cur['message']).'\', '.$cur['hide_smilies'].', '.$cur['posted'].', '.$cur['edited'].', \''.$forum_db->escape($cur['edited_by']).'\', '.$cur['topic_id']
			);
			
			$forum_db->query_build($query) or error(__FILE__, __LINE__);
			
			
			$query_app = array(
				'DELETE'	=> 'posts',
				'WHERE'		=> 'id='.$first_post_data['id']
			);
			
			$forum_db->query_build($query_app) or error(__FILE__, __LINE__);
			
		]]></hook>
		
		<hook id="fn_add_topic_end"><![CDATA[
			
			if (($forum_user['is_admmod'] || ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 1) || $cur_posting['post_approval'] == 0))
			{
				$query_app = array(
					'SELECT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
					'FROM'		=> 'topics',
					'WHERE'		=> 'id='.$new_tid
				);
				
				$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$cur = $forum_db->fetch_assoc($result_app);
				
				$query = array(
					'INSERT'	=> 'id, poster, subject, posted, first_post_id, last_post, last_post_id, last_poster, num_views, num_replies, closed, sticky, moved_to, forum_id',
					'INTO'		=> 'post_approval_topics',
					'VALUES'	=> $new_tid.', \''.$forum_db->escape($cur['poster']).'\', \''.$forum_db->escape($cur['subject']).'\', '.$cur['posted'].', '.$cur['first_post_id'].', '.$cur['last_post_id'].', \''.$forum_db->escape($cur['last_poster']).'\', '.$cur['num_views'].', '.$cur['num_replies'].', '.$cur['closed'].', '.$cur['sticky'].', '.$cur['moved_to'].', '.$cur['forum_id']
				);
				
				$forum_db->query_build($query) or error(__FILE__, __LINE__);
			}
			
		]]></hook>
		
		<hook id="fn_add_topic_start"><![CDATA[
			//If no need to approve posts of this topic or user can post without approval
			global $cur_posting, $forum_user;
			
			if (!($forum_user['is_admmod'] || ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 1) || $cur_posting['post_approval'] == 0))
				return 1;
		]]></hook>
		
		<hook id="fn_add_post_start"><![CDATA[
			//If no need to approve posts of this topic or user can post without approval
			global $cur_posting, $forum_user;
			
			if (!($forum_user['is_admmod'] || ($cur_posting['post_approval'] == 1 && $forum_user['g_without_approval'] == 1) || $cur_posting['post_approval'] == 0))
				return 1;
		]]></hook>
		
		<hook id="ed_qr_update_subject"><![CDATA[
			if (!$forum_user['is_admmod'] && ($cur_post['post_approval'] == 1 && $forum_user['g_without_approval'] == 0))
			{
				$query = array(
					'INSERT'	=> 'poster, subject, posted, last_post, last_poster, forum_id',
					'INTO'		=> 'post_approval_topics',
					'VALUES'	=> '\''.$forum_db->escape($cur_post['poster']).'\', \''.$forum_db->escape($subject).'\', '.$cur_post['posted'].', '.$post_info['posted'].', \''.$forum_db->escape($post_info['poster']).'\', '.$post_info['forum_id']
				);
			}
			$forum_db->query_build($query) or error(__FILE__, __LINE__);
		]]></hook>
		
		<hook id="ed_qr_get_post_info"><![CDATA[
			$query['SELECT'] .= ', f.post_approval';
		]]></hook>

		<hook id="afo_edit_forum_pre_permissions_part"><![CDATA[

			$query_app_post = array(
				'SELECT'	=> 'post_approval',
				'FROM'		=> 'forums',
				'WHERE'		=> 'id='.$forum_id
			);

			$result_app_post = $forum_db->query_build($query_app_post) or error(__FILE__, __LINE__);
			$app_post = $forum_db->fetch_assoc($result_app_post);

			?>
				<div class="content-head">
					<h3 class="hn"><span><?php echo $lang_app_post['forum head'] ?></span></h3>
				</div>
				<div class="ct-box">
					<ul>
						<?php echo "\n\t\t\t\t\t".$lang_app_post['forum info']."\n" ?>
					</ul>
				</div>
				<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">
					<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
						<div class="sf-box select">
							<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_app_post['name check'] ?></span></label><br />
							<span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="allow_app_post" value="1" <?php echo ($app_post['post_approval'] == 1) ? 'checked' : ''; ?> /><?php echo $lang_app_post['forum check'] ?></span>
						</div>
					</div>
				</fieldset>
				
			<?php

		]]></hook>

		<hook id="afo_save_forum_qr_update_forum"><![CDATA[

			$allow_app_post = isset($_POST['allow_app_post']) ? '1' : '0';
			$query['SET'] .= ', post_approval='.$allow_app_post;

		]]></hook>

		<hook id="agr_add_edit_group_user_permissions_fieldset_end"><![CDATA[

			?>
				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?>">
					<legend><span><?php echo $lang_app_post['legend checks'] ?></span></legend>
					<div class="mf-box">
						<div class="mf-item">
							<span class="fld-input"><input type="checkbox" id="fld<?php echo $forum_page['fld_count'] ?>" name="without_approval" value="1"<?php if ($group['g_without_approval'] == '1') echo ' checked="checked"' ?> /></span>
							<label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo $lang_app_post['name check'] ?></label>
						</div>
					</div>
				</fieldset>
			<?php

		]]></hook>

		<hook id="agr_edit_end_qr_update_group"><![CDATA[

			$without_approval = isset($_POST['without_approval']) ? intval($_POST['without_approval']) : '0';
			$query['SET'] .= ', g_without_approval='.$without_approval;

		]]></hook>

		<hook id="co_common"><![CDATA[

			$forum_url['admin_extensions_approvalpost'] = 'admin/extensions.php?section=approvalpost';
			
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			require $ext_info['path'].'/functions.php';
			
			$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));

		]]></hook>
		
		<hook id="ca_fn_generate_admin_menu_new_sublink"><![CDATA[
			
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			require $ext_info['path'].'/post_app_url.php';
		
			if ((FORUM_PAGE_SECTION == 'unapp_posts') && ($forum_user['g_id'] == FORUM_ADMIN))
			{
				$forum_page['admin_submenu']['unapp_topics'] = '<li'.((isset($_GET['topics']) && (FORUM_PAGE == 'admin-unapp_posts-approvalpost')) ? ' class="active"' : ' class="normal"').'><a href="'.forum_link($post_app_url['Topics section']).'">'.$lang_app_post['Unp topics'].'</a></li>';
				$forum_page['admin_submenu']['unapp_posts'] = '<li'.((isset($_GET['all_post']) && (FORUM_PAGE == 'admin-unapp_posts-approvalpost')) ? ' class="active"' : ' class="normal"').'><a href="'.forum_link($post_app_url['Posts section']).'">'.$lang_app_post['Unp posts'].'</a></li>';
				
				if ($forum_config['o_users_check'])
				{
					$forum_page['admin_submenu']['unapp_users'] = '<li'.((isset($_GET['users']) && (FORUM_PAGE == 'admin-unapp_posts-approvalpost')) ? ' class="active"' : ' class="normal"').'><a href="'.forum_link($post_app_url['Users section']).'">'.$lang_app_post['Unp users'].'</a></li>';
				}
			}
			
		]]></hook>
		
		<hook id="ca_fn_generate_admin_menu_new_link"><![CDATA[
			
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			require $ext_info['path'].'/post_app_url.php';
			
			if ($forum_user['g_id'] == FORUM_ADMIN)
			{
				$forum_page['admin_menu']['unapp_posts'] = '<li class="'.((FORUM_PAGE_SECTION == 'unapp_posts') ? 'active' : 'normal').((empty($forum_page['admin_menu'])) ? ' first-item' : '').'"><a href="'.forum_link($post_app_url['Topics section']).'"><span>'.$lang_app_post['Title'].'</span></a></li>';
			}
			
		]]></hook>
		
		<hook id="aex_new_action"><![CDATA[
			
			if ((isset($_GET['all_post']) || isset($_GET['topics'])) && ($section == 'approvalpost') || ($section == 'unapp_posts'))
			{
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
				else
					require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
				require $ext_info['path'].'/post_app_url.php';
				
				$aptid = isset($_GET['aptid']) ? $_GET['aptid'] : 0;
				$del = isset($_GET['del']) ? $_GET['del'] : 0;
				$app = isset($_GET['app']) ? $_GET['app'] : 0;
				$appid = isset($_GET['appid']) ? $_GET['appid'] : 0;
				$p_cr = isset($_GET['p']) ? $_GET['p'] : 0;
				$topics = isset($_GET['topics']) ? $_GET['topics'] : 0;
				
				// Setup breadcrumbs
				$forum_page['crumbs'] = array(
					array($forum_config['o_board_title'], forum_link($forum_url['index'])),
					array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),
					array($lang_app_post['Unp posts'], forum_link($post_app_url['Section']))
				);
				
				if ($aptid || $appid)
				{
					if ($appid)
					{
						$query_app = array(
							'SELECT'	=> 'topic_id',
							'FROM'		=> 'post_approval_posts',
							'WHERE'		=> 'id='.$appid
						);
						
						$res_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
						$tmp_app = $forum_db->fetch_assoc($res_app);
						$aptid = intval($tmp_app['topic_id']);
					}
					
					array_push($forum_page['crumbs'], array($lang_app_post['Topics'], forum_link($post_app_url['Section'])));
				}
				
				define('FORUM_PAGE_SECTION', 'unapp_posts');
				define('FORUM_PAGE', 'admin-unapp_posts-approvalpost');
				require FORUM_ROOT.'header.php';
				
				ob_start();
				
				show_unapproved_posts();
				
				$tpl_app_post = trim(ob_get_contents());
				$tpl_main = str_replace('<!-- forum_main -->', $tpl_app_post, $tpl_main);
				
				ob_end_clean();
				
				require FORUM_ROOT.'footer.php';
			}
			
			if (isset($_GET['users']) && ($section == 'approvalpost') || ($section == 'unapp_posts'))
			{
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
				else
					require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
				require $ext_info['path'].'/post_app_url.php';
				
				// Setup breadcrumbs
				$forum_page['crumbs'] = array(
					array($forum_config['o_board_title'], forum_link($forum_url['index'])),
					array($lang_admin_common['Forum administration'], forum_link($forum_url['admin_index'])),
					array($lang_app_post['Unp posts'], forum_link($post_app_url['Topics section']))
				);
				
				define('FORUM_PAGE_SECTION', 'unapp_posts');
				define('FORUM_PAGE', 'admin-unapp_posts-approvalpost');
				require FORUM_ROOT.'header.php';
				
				ob_start();
				
				show_unapproved_users();
				
				$tpl_app_post = trim(ob_get_contents());
				$tpl_main = str_replace('<!-- forum_main -->', $tpl_app_post, $tpl_main);
				
				ob_end_clean();
				
				require FORUM_ROOT.'footer.php';
			}

		]]></hook>

		<hook id="ft_about_end" priority="10"><![CDATA[
			
			if (!defined('PUN_EXTENSIONS_USED') && !empty($pun_extensions_used))
			{
				define('PUN_EXTENSIONS_USED', 1);
				echo '<p id="extensions-used">Currently used extensions: '.implode(', ', $pun_extensions_used).'. Copyright &copy; 2008 <a href="http://punbb.informer.com/">PunBB</a></p>';
			}
			
		]]></hook>
		
		<hook id="hd_visit_elements"><![CDATA[
			
			if ($forum_user['is_admmod'])
			{
				$forum_url['admin_extensions_approvalpost'] = 'admin/extensions.php?section=approvalpost&topics=1';
				
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
				else
					require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
				
				require $ext_info['path'].'/post_app_url.php';
				
				$query_app = array(
					'SELECT'	=> 'id',
					'FROM'		=> 'post_approval_posts'
				);
				
				$result_app = $forum_db->query_build($query_app) or error(__FILE__, __LINE__);
				
				$query_app = array(
					'SELECT'	=> 'id',
					'FROM'		=> 'post_approval_users'
				);
				
				$result_app_users = $forum_db->query_build($query_app) or error(__FILE__,__LINE__);
				
				if ($forum_db->num_rows($result_app))
					$visit_links[] = '<span id="visit-unapproved"'.(empty($visit_links) ? ' class="first-item"' : '').'><a href="'.forum_link($forum_url['admin_extensions_approvalpost']).'">'.$lang_app_post['show app posts'].' <strong>('.$forum_db->num_rows($result_app).') </strong></a></span>';
				else
					$visit_links[] = '<span id="visit-unapproved"'.(empty($visit_links) ? ' class="first-item"' : '').'><a href="'.forum_link($forum_url['admin_extensions_approvalpost']).'">'.$lang_app_post['show app posts'].'</a></span>';
				
				if ($forum_config['o_users_check'])
					if ($forum_db->num_rows($result_app_users))
						$visit_links[] = '<span id="visit-unapproved_users"'.(empty($visit_links) ? ' class="first-item"' : '').'><a href="'.forum_link($post_app_url['Users section']).'">'.$lang_app_post['Show section'].'</a></span>';
				
				$visit_elements['<!-- forum_visit -->'] = '<p id="visit-links" class="options">'.implode(' ', $visit_links).'</p>';
			}
			
		]]></hook>
		
		<hook id="aop_features_pre_header_load"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

		]]></hook>

		<hook id="aop_features_validation"><![CDATA[

			if (!isset($form['users_check']) || $form['users_check'] != '1') $form['users_check'] = '0';

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

		]]></hook>
		<hook id="aop_features_avatars_fieldset_end"><![CDATA[

			?>
					<div class="content-head">
						<h2 class="hn"><span><?php echo $lang_app_post['Title'] ?></span></h2>
					</div>
					<fieldset class="frm-group group1">
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box checkbox">
								<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="form[users_check]" value="1"<?php if ($forum_config['o_users_check'] == '1') echo ' checked="checked"' ?> /></span>
								<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_app_post['users check name'] ?></span> <?php echo $lang_app_post['users check value'] ?></label>
							</div>
						</div>
					</fieldset>
			<?php

		]]></hook>
		
	</hooks>
</extension>