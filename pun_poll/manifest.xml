<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

	Copyright (C) 2008  PunBB

	PunBB is free software; you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 2 of the License,
	or (at your option) any later version.

	PunBB is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston,
	MA  02111-1307  USA

***********************************************************************
-->

<extension engine="1.0">
	<id>pun_poll</id>
	<title>Polls</title>
	<version>0.7</version>
	<description>Adds polls feature for posts.</description>
	<author>PunBB Development team</author>
	<minversion>1.3 SVN</minversion>
	<maxtestedon>1.3 SVN</maxtestedon>

	<install><![CDATA[

		$schema = array(
			'FIELDS' => array(				
				'topic_id'		=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				),
				'question'			=> array(
					'datatype'		=> 'VARCHAR(200)',
					'allow_null'	=> true
				),
				'read_unvote_users'		=> array(
					'datatype'		=> 'tinyint(1)',
					'allow_null'	=> true
				),
				'revote'			=> array(
					'datatype'		=> 'tinyint(1)',
					'allow_null'	=> true
				),
				'created'	=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> true
				),
				'days_count'	=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				)
			),
			'PRIMARY KEY'	=> array('topic_id')
		);
		$forum_db->create_table('questions', $schema);

		$schema = array(
			'FIELDS'	=> array(
				'id'				=> array(
					'datatype'		=> 'SERIAL',
					'allow_null'	=> false
				),
				'topic_id'		=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				),
				'answer'			=> array(
					'datatype'		=> 'VARCHAR(50)',
					'allow_null'	=> true
				)
			),
			'PRIMARY KEY'	=> array('id')
		);
		$forum_db->create_table('answers', $schema);
		
		$schema = array(
			'FIELDS'		=> array(
				'id'			=> array(
					'datatype'		=> 'SERIAL',
					'allow_null'	=> false
				),
				'topic_id'		=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				),
				'user'			=> array(
					'datatype'		=> 'VARCHAR(50)',
					'allow_null'	=> true
				),
				'ball'			=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> true
				)
			),
			'PRIMARY KEY'	=> array('id')
		);
		$forum_db->create_table('voting', $schema);

		$forum_db->add_field('groups', 'g_poll_add', 'tinyint(1)', false, 1);

		$query_poll_poll = array(
			'INSERT'	=> 'conf_name, conf_value',
			'INTO'		=> 'config',
			'VALUES'	=> '"p_pun_poll_enable_read","0"'
		);
		$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

		$query_poll_poll = array(
			'INSERT'	=> 'conf_name, conf_value',
			'INTO'		=> 'config',
			'VALUES'	=> '"p_pun_poll_enable_revote","0"'
		);
		$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

		$query_poll_poll = array(
			'INSERT'	=> 'conf_name, conf_value',
			'INTO'		=> 'config',
			'VALUES'	=> '"p_pun_poll_max_answers","50"'
		);
		$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

	]]></install>

	<uninstall><![CDATA[

		$forum_db->drop_table('questions');	
		$forum_db->drop_table('answers');
		$forum_db->drop_table('voting');
		$forum_db->drop_field('groups', 'g_poll_add');

		$query_poll = array(
			'DELETE'	=> 'config',
			'WHERE'		=> 'conf_name="p_pun_poll_enable_read" OR conf_name="p_pun_poll_enable_revote" OR conf_name="p_pun_poll_max_answers"'
		);
		$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

	]]></uninstall>

	<hooks>
		<hook id="ca_fn_prune_qr_prune_topics, mr_confirm_delete_topics_qr_delete_topics"><![CDATA[
		    $pun_poll_topic_ids = isset($topic_ids) ? $topic_ids : implode(',', $topics);
			$query_poll = array(
				'DELETE'	=> 'voting',
				'WHERE'		=> 'topic_id IN('.$pun_poll_topic_ids.')
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
			
			$query_poll = array(
				'DELETE'	=> 'questions',
				'WHERE'		=> 'topic_id IN('.$pun_poll_topic_ids.')
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

			$query_poll = array(
				'DELETE'	=> 'answers',
				'WHERE'		=> 'topic_id IN('.$pun_poll_topic_ids.')
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
		]]></hook>
		
		<hook id="fn_delete_topic_qr_delete_topic"><![CDATA[

			$query_poll_poll = array(
				'DELETE'	=> 'voting',
				'WHERE'		=> 'topic_id='.$topic_id
			);
			$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

			$query_poll_poll = array(
				'DELETE'	=> 'questions',
				'WHERE'		=> 'topic_id='.$topic_id
			);
			$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

			$query_poll_poll = array(
				'DELETE'	=> 'answers',
				'WHERE'		=> 'ques_id='.$topic_id
			);
			$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

		]]></hook>

		<hook id="ed_form_submitted"><![CDATA[

			if (isset($_POST['delete_poll']))
			{
				$query_poll = array(
					'DELETE'	=> 'questions',
					'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
				);

				$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

				$query_poll = array(
					'DELETE'	=> 'answers',
					'WHERE'		=> 'id_ques='.intval($cur_post['tid'])
				);

				$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

				$query_poll = array(
					'DELETE'	=> 'voting',
					'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
				);

				$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

				unset($_POST['poll_answer[]']);
				unset($_POST['question_of_poll']);
				unset($_POST['allow_poll_days']);
				unset($_POST['dis_see']);
				unset($_POST['dis_rev']);

				$_POST['poll_ans_count'] = '0';
				$_POST['preview'] = '1';
			}

			if (isset($_POST['update_poll']))
			{
				$_POST['preview'] = '1';
			}

		]]></hook>
		
		<hook id="ed_start"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

		]]></hook>
		<hook id="ed_pre_header_load"><![CDATA[

			if ((isset($_POST['update_poll'])) || (isset($_POST['delete_poll'])))
			{
				if ($_POST['preview_push'] == 0)
					unset($_POST['preview']);
			}

		]]></hook>
		
		<hook id="ed_end_validation"><![CDATA[
			
			$question = isset($_POST['question_of_poll']) ? $_POST['question_of_poll'] : '';
			
			if ($question != '')
			{
				$poll_array_answer = (isset($_POST['poll_answer'])) ? $_POST['poll_answer'] : NULL;
				
				if ($poll_array_answer == NULL)
					$_POST['question_of_poll'] = '';
				
				$count_poll_ans = count($poll_array_answer);
				
				if ($count_poll_ans < 2)
					$_POST['question_of_poll'] = '';
			}
			
		]]></hook>
		
		<hook id="ed_pre_post_edited"><![CDATA[

			//test on the checkbox about want to create voting
			$question = isset($_POST['question_of_poll']) ? $_POST['question_of_poll'] : '';

			if ($question != '')
			{

				$query_poll = array(
					'SELECT'	=> 'answer, id',
					'FROM'		=> 'answers',
					'WHERE'		=> 'id_ques='.intval($cur_post['tid']),
					'ORDER BY'	=> 'id ASC'
				);

				$poll_result = $forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

				$old_arr = NULL;
				$arr_id = NULL;

				if ($forum_db->num_rows($poll_result))
				{
					$old_arr = array();
					$arr_id = array();
					while ($row = $forum_db->fetch_assoc($poll_result))
					{
						$old_arr[] = $row['answer'];
						$arr_id[] = $row['id'];
					}
				}

				$poll_array_answer = (isset($_POST['poll_answer'])) ? $_POST['poll_answer'] : NULL;
				$count_poll_ans = count($poll_array_answer);

				if (($poll_array_answer != NULL) && ($old_arr != NULL))
				{
					$arr1 = array(); // old array which contained in database
					$arr1 = $old_arr;
					$arr2 = array(); // new array which contained in $_POST
					$arr2 = $poll_array_answer;

					if ((count($arr1) >= count($arr2)) && (array_slice($arr1, 0, count($arr2)) != $arr2))
					{
						if ((count($arr1) > count($arr2)) && (array_slice($arr1, 0, count($arr2)) == $arr2))
						{
							if (isset($_POST['del_all_results']))
							{
								$query_poll_p = array(
									'DELETE'	=> 'voting',
									'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
								);

								$forum_db->query_build($query_poll_p) or error(__FILE__, __LINE__);
							}
							else
							{
								$count1 = count($arr1);
								$count2 = count($arr2);

								for ($iter = $count2; $iter < $count1; $iter++)
								{
									$query_poll = array(
										'DELETE'	=> 'voting',
										'WHERE'		=> '(id_topic='.intval($cur_post['tid']).' AND ball='.($iter + 1).')'
									);

									$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

									$arr1[$iter] = '';
								}
							}
						}

						if ((count($arr1) == count($arr2)) && ($arr1 != $arr2))
						{
							if (isset($_POST['del_all_results']))
							{
								$query_poll_p = array(
									'DELETE'	=> 'voting',
									'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
								);

								$forum_db->query_build($query_poll_p) or error(__FILE__, __LINE__);

								$arr1 = $arr2;
							}
							else
							{
								$count_g = count($arr1);

								for ($iter = 0; $iter < $count_g; $iter++)
								{
									if ($arr1[$iter] != $arr2[$iter])
									{
										$query_poll = array(
											'DELETE'	=> 'voting',
											'WHERE'		=> '(id_topic='.intval($cur_post['tid']).' AND ball='.($iter + 1).')'
										);

										$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

										$arr1[$iter] = $arr2[$iter];
									}
								}
							}
						}

						if ((count($arr1) > count($arr2)) && (array_slice($arr1, 0, count($arr2)) != $arr2))
						{
							if (isset($_POST['del_all_results']))
							{
								$query_poll_p = array(
									'DELETE'	=> 'voting',
									'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
								);

								$forum_db->query_build($query_poll_p) or error(__FILE__, __LINE__);

								$arr1 = $arr2;
							}
							else
							{
								$count1 = count($arr1);
								$count2 = count($arr2);

								for ($iter = $count1; $iter > $count2; $iter--)
								{
									$query_poll = array(
										'DELETE'	=> 'voting',
										'WHERE'		=> '(id_topic='.intval($cur_post['tid']).' AND ball='.($iter + 1).')'
									);

									$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

									array_pop($arr1);
								}

								for ($iter = 0; $iter < $count2; $iter++)
								{
									if ($arr1[$iter] != $arr2[$iter])
									{
										$query_poll = array(
											'DELETE'	=> 'voting',
											'WHERE'		=> '(id_topic='.intval($cur_post['tid']).' AND ball='.($iter + 1).')'
										);

										$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

										$arr1[$iter] = $arr2[$iter];
									}
								}
							}
						}

						$poll_array_answer = $arr1;
					}
				}

				if ($poll_array_answer == null)
					message($lang_pun_poll['Incorrect data']);

				$query_poll_poll = array(
					'DELETE'	=> 'answers',
					'WHERE'		=> 'id_ques='.intval($cur_post['tid'])
				);

				$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

				for ($iter = 0; $iter < $count_poll_ans ; $iter++)
				{

					if ($poll_array_answer[$iter] != '')
					{
						$query_poll = array(
							'INSERT'	=> 'id_ques, answer',
							'INTO'		=> 'answers',
							'VALUES'	=> intval($cur_post['tid']).', "'.$forum_db->escape($poll_array_answer[$iter]).'"'
						);

						$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
					}
				}

				$query_poll = array(
					'SELECT'	=> 'id_topic',
					'FROM'		=> 'questions',
					'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
				);

				$poll_result = $forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

				if ($forum_db->num_rows($poll_result))
				{
					$query_poll = array(
						'UPDATE'	=> 'questions',
						'SET'		=> 'question=\''.$forum_db->escape($question).'\'',
						'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
					);

					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
				}
				else
				{
					$query_poll = array(
						'INSERT'	=> 'id_topic, question',
						'INTO'		=> 'questions',
						'VALUES'	=> intval($cur_post['tid']).', "'.$forum_db->escape($question).'"'
					);

					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
				}

				if (isset($_POST['allow_poll_days']))
				{
					if (isset($_POST['allow_poll_days']))
					{
						if ($_POST['allow_poll_days'] == '')
							$_POST['allow_poll_days'] = 0;

						if ($_POST['allow_poll_days'] < 0)
							$_POST['allow_poll_days'] = 0;
					}
					$query_poll = array(
						'UPDATE'	=> 'questions',
						'SET'		=> 'able_start_day='.time().', able_end_day='.(($_POST['allow_poll_days'] != 0) ? (time() + intval($_POST['allow_poll_days']) * 3600 * 24) : '0'),
						'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
					);

					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
				}

				if (isset($_POST['dis_see']))
				{
					$query_poll = array(
						'UPDATE'	=> 'questions',
						'SET'		=> 'able_see=\'1\'',
						'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
					);

					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
				}
				else
				{
					$query_poll = array(
						'UPDATE'	=> 'questions',
						'SET'		=> 'able_see=\'0\'',
						'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
					);

					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
				}

				if (isset($_POST['dis_rev']))
				{
					$query_poll = array(
						'UPDATE'	=> 'questions',
						'SET'		=> 'able_rev=\'1\'',
						'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
					);

					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
				}
				else
				{
					$query_poll = array(
						'UPDATE'	=> 'questions',
						'SET'		=> 'able_rev=\'0\'',
						'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
					);

					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
				}
			}
			
		]]></hook>
		
		<hook id="ed_main_fieldset_end"><![CDATA[

			$query_poll_poll = array(
				'SELECT'	=> 'id',
				'FROM'		=> 'topics AS t',
				'WHERE'		=> 't.first_post_id='.$id
			);

			$poll_result_poll = $forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

			if ($forum_db->num_rows($poll_result_poll))
			{
				$count_poll_ans = 0;
				$question = array('question'	=> '');
				$poll_array_answer = array();

				$query_poll = array(
					'SELECT'	=> 'able_start_day, able_end_day',
					'FROM'		=> 'questions',
					'WHERE'		=> 'id_topic='.$cur_post['tid']
				);

				$poll_result_able_se_days = $forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

				$days_poll = NULL;

				if (isset($_POST['allow_poll_days']))
				{
					if ($_POST['allow_poll_days'] != '')
						$days_poll = ($_POST['allow_poll_days'] > 0) ? $_POST['allow_poll_days'] : NULL;
				}
				else if ($forum_db->num_rows($poll_result_able_se_days))
				{
					$days = $forum_db->fetch_assoc($poll_result_able_se_days);

					if ($days['able_end_day'] != '0')
						$days_poll = floor((intval($days['able_end_day']) - intval($days['able_start_day'])) / (3600 * 24));
				}

				$query_poll = array(
					'SELECT'	=> 'conf_value',
					'FROM'		=> 'config',
					'WHERE'		=> 'conf_name=\'p_pun_poll_max_answers\''
				);

				$poll_result = $forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

				if ($forum_db->num_rows($poll_result))
					$max_count = $forum_db->fetch_assoc($poll_result);

				if (isset($_POST['poll_answer']) && isset($_POST['question_of_poll']))
				{
					$poll_array_answer = $_POST['poll_answer'];
					$question['question'] = $_POST['question_of_poll'];
				}
				else
				{
					$query_poll = array(
						'SELECT'	=> 'question',
						'FROM'		=> 'questions AS q',
						'JOINS'		=> array(
							array(
								'JOIN'	=> 'topics AS t',
								'ON'	=> '(q.id_topic=t.id AND t.first_post_id='.$id.')'
							)
						)
					);

					$poll_result_ques = $forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

					if ($forum_db->num_rows($poll_result_ques))
					{
						$question = $forum_db->fetch_assoc($poll_result_ques);
						$query_poll = array(
							'SELECT'	=> 'answer',
							'FROM'		=> 'answers AS a',
							'JOINS'		=> array(
								array(
									'JOIN'	=> 'questions AS q',
									'ON'	=> '(a.id_ques=q.id_topic AND q.question=\''.$forum_db->escape($question['question']).'\')'
								)
							),
							'ORDER BY'	=> 'a.id ASC'
						);

						$poll_result_ans = $forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

						while ($row_ans = $forum_db->fetch_assoc($poll_result_ans))
						{
							array_push($poll_array_answer, $row_ans['answer']);
						}
					}
				}

				if (isset($_POST['update_poll']) && (isset($_POST['poll_ans_count'])))
					$count_poll_ans = intval($_POST['poll_ans_count']);
				else
					$count_poll_ans = sizeof($poll_array_answer);

				if ($count_poll_ans < 2)
					$count_poll_ans = 2;

				if ($count_poll_ans > $max_count['conf_value'])
					$count_poll_ans = intval($max_count['conf_value']);

				$query_poll = array(
					'SELECT'	=> 'able_see, able_rev',
					'FROM'		=> 'questions',
					'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
				);

				$poll_result = $forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

				$able = $forum_db->fetch_assoc($poll_result);

				?>
					<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box text">
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_pun_poll['Poll question'] ?></span><small></small></label><br />
								<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="question_of_poll" size="80" maxlength="150" value="<?php echo ($question['question'] != '') ? $question['question'] : '' ?>" /></span>
							</div>
						</div>
						
						<?php

						for ($iter = 0; $iter < $count_poll_ans; $iter++)
						{

						?>
							
							<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
								<div class="sf-box text">
									<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_pun_poll['Voting answer'] ?></span><small></small></label><br />
									<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="poll_answer[]" size="80" maxlength="150" value="<?php echo ((isset($poll_array_answer[$iter])) ? $poll_array_answer[$iter] : '') ?>" /></span>
								</div>
							</div>	

						<?php

						}

						$poll_dis_see = 0;
						$poll_dis_rev = 0;

						if (isset($_POST['dis_see']))
						{
							$poll_dis_see = 1;
						}
						else if ($forum_config['p_pun_poll_enable_read'] == '0')
						{
							if ($able['able_see'] == 1)
								$poll_dis_see = 1;
						}
						else
						{
							$poll_dis_see = 2;
						}

						if (isset($_POST['dis_rev']))
						{
							$poll_dis_rev = 1;
						}
						else if ($forum_config['p_pun_poll_enable_revote'] == '0')
						{
							if ($able['able_rev'] == 1)
								$poll_dis_rev = 1;
						}
						else
						{
							$poll_dis_rev = 2;
						}

						?>

						<input type="hidden" name="preview_push" value="<?php echo (isset($_POST['preview'])) ? '1' : '0'; ?>" />
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box text">
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_pun_poll['Allow days'] ?></span><small></small></label><br />
								<span class="fld-input"><input type="text" id="fld<?php echo $forum_page['fld_count'] ?>" name="allow_poll_days" size="20" maxlength="20" value="<?php echo ($days_poll != NULL) ? intval($days_poll) : ''; ?>" /></span>
							</div>
						</div>
					</fieldset>
					
					
					<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?>">
						<legend><span><?php echo $lang_pun_poll['Additional options'] ?></span></legend>
						<div class="mf-box checkbox">			
							<div class="mf-item"><span class="fld-input"><input type="checkbox" id="fld <?php echo (++$forum_page['fld_count'])?>" name="dis_see" value="1" <?php echo ($forum_config['p_pun_poll_enable_read'] != '0') ? 'disabled' : (($poll_dis_see == 1) ? 'checked' : '') ?> /></span> <label for="fld<?php echo $forum_page['fld_count']?>"><?php echo $lang_pun_poll['See results']?></label></div>
							<div class="mf-item"><span class="fld-input"><input type="checkbox" id="fld <?php echo (++$forum_page['fld_count'])?>" name="dis_rev" value="1" <?php echo ($forum_config['p_pun_poll_enable_revote'] != '0') ? 'disabled' : (($poll_dis_rev == 1) ? 'checked' : '') ?> /></span> <label for="fld<?php echo $forum_page['fld_count']?>"><?php echo $lang_pun_poll['Able revote']?></label></div>
						
							
							<?php

								$query_poll = array(
									'SELECT'	=> 'id',
									'FROM'		=> 'voting',
									'WHERE'		=> 'id_topic='.intval($cur_post['tid'])
								);

								$poll_result = $forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

								if ($forum_db->num_rows($poll_result))
								{

								?>											
									<div class="mf-item"><span class="fld-input"><input type="checkbox" id="fld <?php echo (++$forum_page['fld_count'])?>" name="del_all_results" value="1" <?php echo (isset($_POST['del_all_results'])) ? 'checked' : ''; ?> /></span> <label for="fld<?php echo $forum_page['fld_count']?>"><?php echo $lang_pun_poll['Delete all']?></label></div>										

								<?php

								}

							?>
						</div>
					</fieldset>
					
					<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box text">
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_pun_poll['Summary count']; ?></span><small></small></label><br />
								<span class="fld-input"><input type="text" name="poll_ans_count" size="2px" maxlength="20" value="<?php echo $count_poll_ans ?>" /></span>		
							</div>
							<div class="frm-buttons">
								<span class="submit"><input type="submit" name="update_poll" value="Update poll" /></span>
								<?php echo (($count_poll_ans >= 2) && ($question['question'] != '')) ? '<span class="submit"><input type="submit" name="delete_poll" value="Delete_poll" /></span>' : ''; ?>			
							</div>
					</div>

				<?php

			}

		]]></hook>

		<hook id="po_posting_location_selected"><![CDATA[
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

			if (isset($fid))
			{
				//User press update poll
				if (isset($_POST['update_poll']))
				{
					unset($_POST['form_sent']);
			
					$subject = forum_trim($_POST['req_subject']);
					if ($subject == '')
						$errors[] = $lang_post['No subject'];
					else if (utf8_strlen($subject) > 70)
						$errors[] = $lang_post['Too long subject'];
					else if ($forum_config['p_subject_all_caps'] == '0' && utf8_strtoupper($subject) == $subject && !$forum_page['is_admmod'])
						$errors[] = $lang_post['All caps subject'];

					// Clean up message from POST
					$message = forum_linebreaks(forum_trim($_POST['req_message']));
					if (strlen($message) > FORUM_MAX_POSTSIZE_BYTES)
						$errors[] = sprintf($lang_post['Too long message'], forum_number_format(strlen($message)), forum_number_format(FORUM_MAX_POSTSIZE_BYTES));
					else if ($forum_config['p_message_all_caps'] == '0' && utf8_strtoupper($message) == $message && !$forum_page['is_admmod'])
						$errors[] = $lang_post['All caps message'];

					$options_count = (!isset($_POST['poll_ans_count']) || intval($_POST['poll_ans_count']) < 2) ? null : intval($_POST['poll_ans_count']);
					if ($options_count > $forum_config['p_pun_poll_max_answers'])
						message(sprintf($lang_pun_poll['Max cnt options'], $forum_config['p_pun_poll_max_answers']));
					if ($options_count == null)
						message($lang_pun_poll['Min cnt options']);
				}
				else
					$options_count = 2;
				$poll_answers = (isset($_POST['poll_answer']) && !empty($_POST['poll_answer']) && is_array($_POST['poll_answer'])) ? (array) $_POST['poll_answer'] : null;
				if ($poll_answers == null && !empty($_POST['poll_answer']))
					message($lang_common['Bad request']);
				$days_poll = isset($_POST['allow_poll_days']) && !empty($_POST['allow_poll_days']) ? intval($_POST['allow_poll_days']) : 30;
				if ($days_poll > 30 || $days_poll < 1)
					message($lang_pun_poll['Days limit']);
			}

		]]></hook>

		<hook id="po_pre_redirect"><![CDATA[
			if ($fid)
			{
				$question = (isset($_POST['question_of_poll'])) ? forum_trim($_POST['question_of_poll']) : '';

				//Validate of pull_answers
				$answers = array();
				if ($poll_answers != null)
				{				
					for ($ans_num = 0; $ans_num < count($poll_answers); $ans_num++)
					{
						 $ans = forum_trim($poll_answers[$ans_num]);
						 if (!empty($ans))
							$answers[] = $ans;
					}
					if (!empty($answers))
						$answers = array_unique($answers);
				}
				if (!empty($question) && !empty($answers) && count($answers) >= 2)
				{
					//Add question to DB
					$read_unvote_users = ($forum_config['p_pun_poll_enable_read'] && isset($_POST['read_unvote_users']) && $_POST['read_unvote_users'] == 1) ? 1 : 0;
					$revote = ($forum_config['p_pun_poll_enable_revote'] && isset($_POST['revouting']) && $_POST['revouting'] == 1) ? 1 : 0;
					$query_poll = array(
						'INSERT'	=> 'topic_id, question, read_unvote_users, revote, created, days_count',
						'INTO'		=> 'questions',
						'VALUES'	=> $new_tid.', \''.$forum_db->escape($question).'\', '.$read_unvote_users.', '.$revote.', '.time().', '.$days_poll
					);
					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

					//Add answers to DB
					foreach ($answers as $ans)
					{
						$query_poll = array(
							'INSERT'	=> 'topic_id, answer',
							'INTO'		=> 'answers',
							'VALUES'	=> $new_tid.', \''.$forum_db->escape($ans).'\''
						);
						$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
					}
				}
			}
		]]></hook>

		<hook id="po_req_info_fieldset_end"><![CDATA[
			if ($fid && empty($forum_user['is_guest']))
			{
				if ($forum_user['g_poll_add'] || $forum_user['is_admmod'])
				{

			?>
					<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>"">
							<div class="sf-box text">
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
									<span>
										<?php echo $lang_pun_poll['Poll question'] ?>
									</span>
								</label>
								<br/>
								<span class="fld-input">
									<input type="text" id="quest" name="question_of_poll" size="80" maxlength="150"  value="<?php echo (isset($_POST['question_of_poll'])) ? forum_htmlencode(forum_trim($_POST['question_of_poll'])) : '' ?>">
								</span>
							</div>
						</div>
						<?php

						//Validate of pull_answers
						if ($poll_answers != null)
						{
							for ($ans_num = 0; $ans_num < count($poll_answers); $ans_num++)
								$poll_answers[$ans_num] = forum_trim($poll_answers[$ans_num]);
							$poll_answers = array_unique($poll_answers);
						}

						for ($opt_num = 0; $opt_num < $options_count; $opt_num++)
						{

						?>
							<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>"">
								<div class="sf-box text">
									<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
										<span>
											<?php echo $lang_pun_poll['Voting answer'] ?>
										</span>
									</label>
									<br/>
									<span class="fld-input">
										<input id="fld<?php echo $forum_page['fld_count'] ?>" type="text" name="poll_answer[]" size="80" maxlength="70" value="<?php echo ($poll_answers != null && isset($poll_answers[$opt_num]) ? forum_htmlencode($poll_answers[$opt_num]) : '') ?>">
									</span>
								</div>
							</div>
						<?php

						}

						?>
					</fieldset>
					<fieldset class="frm-group frm-hdgroup group<?php echo ++$forum_page['group_count'] ?>">
						<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?> mf-head">
							<legend>
								<span><?php echo $lang_pun_poll['Summary count'] ?></span>
							</legend>
							<div class="mf-box">
								<div class="mf-field mf-field1">
									<label for="fld1">
										<span class="fld-label"><?php echo $lang_pun_poll['Count']; ?></span>
									</label>
									<br/>
									<span class="fld-input">
										<input id="fld<?php echo ++$forum_page['fld_count'] ?>" type="text" name="poll_ans_count" size="5" maxlength="5" value="<?php echo $options_count ?>">
									</span>
								</div>
								<div class="mf-field">
									<span class="submit">
										<input type="submit" name="update_poll" value="<?php echo $lang_pun_poll['Button note'] ?>">
									</span>
								</div>
							</div>                
						</fieldset>
					</fieldset>
					<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">
						<?php if ($forum_config['p_pun_poll_enable_read']): ?>
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>"">
							<div class="sf-box checkbox">
								<span class="fld-input">
									<input type="checkbox" id="first_option" name="read_unvote_users" <?php echo isset($_POST['read_unvote_users']) ? 'checked' : '' ?>/>
								</span>
								<label for="fld<?php echo $forum_page['fld_count'] ?>">
									<span><?php echo $lang_pun_poll['Show poll res'] ?></span>
									<?php echo $lang_pun_poll['See results'] ?>
								</label>
							</div>
						</div>
						<?php endif; ?>
						<?php if ($forum_config['p_pun_poll_enable_revote']): ?>
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>"">
							<div class="sf-box checkbox">
								<span class="fld-input">
									<input type="checkbox" id="second_option" name="revouting" <?php echo isset($_POST['revouting']) ? 'checked' : '' ?>/>
								</span>
								<label for="fld<?php echo $forum_page['fld_count'] ?>">
									<span><?php echo $lang_pun_poll['All ch vote'] ?></span>
									<?php echo $lang_pun_poll['Able revote'] ?>
								</label>
							</div>
						</div>
						<?php endif; ?>
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box text">
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
									<span>
										<?php echo $lang_pun_poll['Allow days'] ?>
									</span>
								</label>
								<br/>
								<span class="fld-input">
									<input id="fld<?php echo $forum_page['fld_count'] ?>" type="text" name="allow_poll_days" size="5" maxlength="5" value="<?php echo $days_poll; ?>">
								</span>
							</div>
						</div>
					</fieldset>
					<?php

				}
			}

		]]></hook>

		<hook id="vt_main_output_start"><![CDATA[
			
			//require $ext_info['path'].'/show_poll.php';
			
		]]></hook>		

		<hook id="vt_start"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

		]]></hook>

		<hook id="aop_features_pre_header_load"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

		]]></hook>

		<hook id="aop_features_validation"><![CDATA[

			if (!isset($form['pun_poll_enable_read']) || $form['pun_poll_enable_read'] != '1') $form['pun_poll_enable_read'] = '0';
			if (!isset($form['pun_poll_enable_revote']) || $form['pun_poll_enable_revote'] != '1') $form['pun_poll_enable_revote'] = '0';
			$form['pun_poll_max_answers'] = intval($form['pun_poll_max_answers']);

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			if ($form['pun_poll_max_answers'] > 100)
			{
				$form['pun_poll_max_answers'] = 100;
				$interval_error = $lang_pun_poll['Max number'];
			}
			if ($form['pun_poll_max_answers'] < 2)
			{
				$form['pun_poll_max_answers'] = 2;
				$interval_error = $lang_pun_poll['Min number'];
			}

		]]></hook>
		<hook id="aop_features_avatars_fieldset_end"><![CDATA[

			?>
					<div class="content-head">
						<h2 class="hn"><span><?php echo $lang_pun_poll['Name plugin'] ?></span></h2>
					</div>
					<?php if (isset($interval_error)): ?>
					<div class="ct-box">
						<p><?php echo $interval_error ?></p>
					</div>
					<?php endif; ?>
					<fieldset class="frm-group group1">
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box checkbox">
								<span class="fld-input">
									<input id="fld<?php echo ++$forum_page['fld_count'] ?>" type="checkbox" name="form[pun_poll_enable_revote]" value="1"<?php if ($forum_config['p_pun_poll_enable_revote'] == '1') echo ' checked="checked"' ?>/>
								</span>
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
									<span><?php echo $lang_pun_poll['Disable revoting info'] ?></span>
									<?php echo $lang_pun_poll['Disable revoting'] ?>
								</label>
							</div>
						</div>
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box checkbox">
								<span class="fld-input">
									<input id="fld<?php echo ++$forum_page['fld_count'] ?>" type="checkbox" name="form[pun_poll_enable_read]" value="1"<?php if ($forum_config['p_pun_poll_enable_read'] == '1') echo ' checked="checked"' ?>/>
								</span>
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
									<span><?php echo $lang_pun_poll['Disable see results'] ?></span>
								</label>
								<?php echo $lang_pun_poll['Disable see results info'] ?>
							</div>
						</div>
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box text">
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
									<span><?php echo $lang_pun_poll['Maximum answers info'] ?></span>
									<small><?php echo $lang_pun_poll['Maximum answers'] ?></small>
								</label>
								</br>
								<span class="fld-input">
									<input id="fld<?php echo $forum_page['fld_count'] ?>" type="text" name="form[pun_poll_max_answers]" size="6" maxlength="6" value="<?php echo $forum_config['p_pun_poll_max_answers'] ?>"/>
								</span>
							</div>
						</div>
					</fieldset>					
			<?php

		]]></hook>

		<hook id="agr_edit_end_qr_update_group"><![CDATA[

			$query_poll['SET'] .= ', g_poll_add='.((isset($_POST['poll_add']) && $_POST['poll_add'] == '1') ? 1 : 0);

		]]></hook>

		<hook id="agr_add_edit_group_user_permissions_fieldset_end"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			?>

				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?>">
					<legend>
						<span><?php echo $lang_pun_poll['Permission'] ?></span>
					</legend>
					<div class="mf-box">
						<div class="mf-item">
							<span class="fld-input">
								<input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="poll_add" value="1"<?php if ($group['g_poll_add'] == '1') echo ' checked="checked"' ?>/>
							</span>
							<label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo $lang_pun_poll['Poll add'] ?></label>
						</div>
					</div>
				</fieldset>

			<?php

		]]></hook>

		<hook id="co_common"><![CDATA[
			$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));
		]]></hook>

		<hook id="ft_about_end" priority="10"><![CDATA[
			if (!defined('PUN_EXTENSIONS_USED') && !empty($pun_extensions_used))
			{
				define('PUN_EXTENSIONS_USED', 1);
				echo '<p id="extensions-used">Currently used extensions: '.implode(', ', $pun_extensions_used).'. Copyright &copy; 2008 <a href="http://punbb.informer.com/">PunBB</a></p>';
			}
		]]></hook>
	</hooks>
</extension>
