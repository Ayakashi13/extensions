<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
/**
 * Allows users to create voting
 *
 * @copyright Copyright (C) 2008 PunBB
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * @package pun_poll
 */
-->

<extension engine="1.0">
	<id>pun_poll</id>
	<title>Polls</title>
	<version>0.7</version>
	<description>Adds polls feature for topics.</description>
	<author>PunBB Development team</author>
	<minversion>1.3 SVN</minversion>
	<maxtestedon>1.3 SVN</maxtestedon>

	<install><![CDATA[
		$schema = array(
			'FIELDS' => array(
				'topic_id'		=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				),
				'question'			=> array(
					'datatype'		=> 'VARCHAR(200)',
					'allow_null'	=> false
				),
				'read_unvote_users'		=> array(
					'datatype'		=> 'tinyint(1)',
					'allow_null'	=> true
				),
				'revote'			=> array(
					'datatype'		=> 'tinyint(1)',
					'allow_null'	=> true
				),
				'created'	=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				),
				'days_count'	=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> true
				),
				'votes_count'	=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> true
				)
			),
			'PRIMARY KEY'	=>	array('topic_id')
		);
		$forum_db->create_table('questions', $schema);

		$schema = array(
			'FIELDS'		=> array(
				'id'			=> array(
					'datatype'		=> 'SERIAL',
					'allow_null'	=> false
				),
				'topic_id'		=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				),
				'user_id'			=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				),
				'answer_id'			=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				)
			),
			'PRIMARY KEY'	=>	array('id')
		);
		$forum_db->create_table('voting', $schema);

		$schema = array(
			'FIELDS'	=> array(
				'id'				=> array(
					'datatype'		=> 'SERIAL',
					'allow_null'	=> false
				),
				'topic_id'		=> array(
					'datatype'		=> 'int(10)',
					'allow_null'	=> false
				),
				'answer'			=> array(
					'datatype'		=> 'VARCHAR(100)',
					'allow_null'	=> true
				)
			),
			'PRIMARY KEY'	=>	array('id')
		);
		$forum_db->create_table('answers', $schema);

		$forum_db->add_field('groups', 'g_poll_add', 'tinyint(1)', false, 1);

		$query_poll_poll = array(
			'INSERT'	=> 'conf_name, conf_value',
			'INTO'		=> 'config',
			'VALUES'	=> '"p_pun_poll_enable_read","0"'
		);
		$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

		$query_poll_poll = array(
			'INSERT'	=> 'conf_name, conf_value',
			'INTO'		=> 'config',
			'VALUES'	=> '"p_pun_poll_enable_revote","0"'
		);
		$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);

		$query_poll_poll = array(
			'INSERT'	=> 'conf_name, conf_value',
			'INTO'		=> 'config',
			'VALUES'	=> '"p_pun_poll_max_answers","50"'
		);
		$forum_db->query_build($query_poll_poll) or error(__FILE__, __LINE__);
	]]></install>

	<uninstall><![CDATA[
		$forum_db->drop_table('questions');	
		$forum_db->drop_table('answers');
		$forum_db->drop_table('voting');
		$forum_db->drop_field('groups', 'g_poll_add');

		$query_poll = array(
			'DELETE'	=> 'config',
			'WHERE'		=> 'conf_name="p_pun_poll_enable_read" OR conf_name="p_pun_poll_enable_revote" OR conf_name="p_pun_poll_max_answers"'
		);
		$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
	]]></uninstall>

	<hooks>
		<hook id="ca_fn_prune_qr_prune_topics, mr_confirm_delete_topics_qr_delete_topics"><![CDATA[
		    $pun_poll_topic_ids = isset($topic_ids) ? $topic_ids : implode(',', $topics);
			$query_poll = array(
				'DELETE'	=> 'voting',
				'WHERE'		=> 'topic_id IN('.$pun_poll_topic_ids.')
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
			
			$query_poll = array(
				'DELETE'	=> 'questions',
				'WHERE'		=> 'topic_id IN('.$pun_poll_topic_ids.')
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

			$query_poll = array(
				'DELETE'	=> 'answers',
				'WHERE'		=> 'topic_id IN('.$pun_poll_topic_ids.')
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
		]]></hook>
		
		<hook id="fn_delete_topic_qr_delete_topic"><![CDATA[

			$query_poll = array(
				'DELETE'	=> 'voting',
				'WHERE'		=> 'topic_id='.$topic_id
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

			$query_poll = array(
				'DELETE'	=> 'questions',
				'WHERE'		=> 'topic_id='.$topic_id
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

			$query_poll = array(
				'DELETE'	=> 'answers',
				'WHERE'		=> 'ques_id='.$topic_id
			);
			$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

		]]></hook>

		<hook id="po_posting_location_selected, ed_main_output_start"><![CDATA[
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			//Validate of input in pun_poll form
			if ((defined('FORUM_PAGE') && FORUM_PAGE == 'postedit') || isset($fid))
			{
				//User press update poll
				if (isset($_POST['update_poll']))
				{
					unset($_POST['form_sent']);

					$subject = forum_trim($_POST['req_subject']);
					if ($subject == '')
						$errors[] = $lang_post['No subject'];
					else if (utf8_strlen($subject) > 70)
						$errors[] = $lang_post['Too long subject'];
					else if ($forum_config['p_subject_all_caps'] == '0' && utf8_strtoupper($subject) == $subject && !$forum_page['is_admmod'])
						$errors[] = $lang_post['All caps subject'];

					// Clean up message from POST
					$message = forum_linebreaks(forum_trim($_POST['req_message']));
					if (strlen($message) > FORUM_MAX_POSTSIZE_BYTES)
						$errors[] = sprintf($lang_post['Too long message'], forum_number_format(strlen($message)), forum_number_format(FORUM_MAX_POSTSIZE_BYTES));
					else if ($forum_config['p_message_all_caps'] == '0' && utf8_strtoupper($message) == $message && !$forum_page['is_admmod'])
						$errors[] = $lang_post['All caps message'];

					$options_count = (!isset($_POST['poll_ans_count']) || intval($_POST['poll_ans_count']) < 2) ? null : intval($_POST['poll_ans_count']);
					if ($options_count > $forum_config['p_pun_poll_max_answers'])
						message(sprintf($lang_pun_poll['Max cnt options'], $forum_config['p_pun_poll_max_answers']));
					if ($options_count == null)
						message($lang_pun_poll['Min cnt options']);
				}
				else
					$options_count = 2;
				$poll_answers = (isset($_POST['poll_answer']) && !empty($_POST['poll_answer']) && is_array($_POST['poll_answer'])) ? (array) $_POST['poll_answer'] : null;
				if ($poll_answers == null && !empty($_POST['poll_answer']))
					message($lang_common['Bad request']);
				$days_poll = isset($_POST['allow_poll_days']) && !empty($_POST['allow_poll_days']) ? intval($_POST['allow_poll_days']) : null;
				if ($days_poll != null && ($days_poll > 30 || $days_poll < 1))
					message($lang_pun_poll['Days limit']);
				$votes_poll = isset($_POST['allow_poll_votes']) && !empty($_POST['allow_poll_votes']) ? intval($_POST['allow_poll_votes']) : null;
				if ($votes_poll != null && ($votes_poll > 500 || $votes_poll < 2))
					message($lang_pun_poll['Votes count']);
				if (isset($_POST['form_sent']) && isset($_POST['question']) && $days_poll == null && $votes_poll == null)
					message($lang_pun_poll['Input error']);
			}
		]]></hook>

		<hook id="po_pre_redirect"><![CDATA[
			if ($fid)
			{	//TODO: Add notice for votes, days, etc
				$question = (isset($_POST['question_of_poll'])) ? forum_trim($_POST['question_of_poll']) : '';

				//Validate of pull_answers
				$answers = array();
				if ($poll_answers != null)
				{				
					for ($ans_num = 0; $ans_num < count($poll_answers); $ans_num++)
					{
						 $ans = forum_trim($poll_answers[$ans_num]);
						 if (!empty($ans) && strlen($ans) <= 100)
							$answers[] = $ans;
					}
					if (!empty($answers) )
						$answers = array_unique($answers);
				}
				if (!empty($question) && !empty($answers) && count($answers) >= 2 && strlen($question) <= 200)
				{
					//Add question to DB
					$read_unvote_users = ($forum_config['p_pun_poll_enable_read'] && isset($_POST['read_unvote_users']) && $_POST['read_unvote_users'] == 1) ? 1 : 0;
					$revote = ($forum_config['p_pun_poll_enable_revote'] && isset($_POST['revouting']) && $_POST['revouting'] == 1) ? 1 : 0;
					if ($days_poll != null)
						$votes_poll = '\'NULL\'';
					else
						$days_poll = '\'NULL\'';

					$query_poll = array(
						'INSERT'	=> 'topic_id, question, read_unvote_users, revote, created, days_count, votes_count',
						'INTO'		=> 'questions',
						'VALUES'	=> $new_tid.', \''.$forum_db->escape($question).'\', '.$read_unvote_users.', '.$revote.', '.time().', '.$days_poll.', '.$votes_poll
					);
					$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);

					//Add answers to DB
					foreach ($answers as $ans)
					{
						$query_poll = array(
							'INSERT'	=> 'topic_id, answer',
							'INTO'		=> 'answers',
							'VALUES'	=> $new_tid.', \''.$forum_db->escape($ans).'\''
						);
						$forum_db->query_build($query_poll) or error(__FILE__, __LINE__);
					}
				}
			}
		]]></hook>

		<hook id="po_req_info_fieldset_end"><![CDATA[
			include $ext_info['path'].'/functions.php';
			if (($fid && empty($forum_user['is_guest'])) && ($forum_user['g_poll_add'] || $forum_user['is_admmod']))
				form_of_poll( isset($_POST['question_of_poll']) ? forum_htmlencode(forum_trim($_POST['question_of_poll'])) : '', $poll_answers , $options_count, $days_poll, $votes_poll);
		]]></hook>

		<hook id="vt_modify_topic_info"><![CDATA[
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';			

			//Get info about poll
			$query_pun_poll = array(
				'SELECT'	=>	'question, read_unvote_users, revote, created, days_count, votes_count',
				'FROM'		=>	'questions',
				'WHERE'		=>	'topic_id = '.$id	
			);
			$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);

			//Is there something?
			if ($forum_db->num_rows($result_pun_poll) > 0)
			{
				list($question, $read_unvote_users, $revote, $created, $days_count, $max_votes_count) = $forum_db->fetch_row($result_pun_poll);

				if ($days_count != 0 && time() > $created + $days_count * 86400)
					$end_voting = true;
				else if ($max_votes_count != 0)
				{
					//Show voting results
					$query_pun_poll = array(
						'SELECT'	=>	'COUNT(id)',
						'FROM'		=>	'voting',
						'WHERE'		=>	'topic_id='.$id
					);
					$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
					if ($forum_db->num_rows($result_pun_poll) > 0)
						list($vote_count) = $forum_db->fetch_row($result_pun_poll);

					if (isset($vote_count) && $vote_count > 0 && $vote_count > $max_votes_count)
						$end_voting = true;
				}
				if (isset($_POST['vote']))
				{
					if (isset($end_voting))
						message($lang_pun_poll['End of vote']);

					$answer_id = isset($_POST['answer']) ? intval($_POST['answer']) : 0;
					if ($answer_id < 1)
						message($lang_common['Bad request']);

					//Is there question with this id?
					$query_pun_poll = array(
						'SELECT'	=>	'1',
						'FROM'		=>	'answers',
						'WHERE'		=>	'topic_id = '.$id.' AND id = '.$answer_id
					);
					$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
					if ($forum_db->num_rows($result_pun_poll) < 1)
						message($lang_common['Bad request']);

					//Have user voted?
					$query_pun_poll = array(
						'SELECT'	=>	'answer_id',
						'FROM'		=>	'voting',
						'WHERE'		=>	'topic_id = '.$id.' AND user_id = '.$forum_user['id']
					);
					$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
					if (!$revote && $forum_db->num_rows($result_pun_poll) > 0)
						message($lang_pun_poll['User vote error']);

					//If user have voted we update table
					if ($revote && $forum_db->num_rows($result_pun_poll) > 0)
					{
						list($old_answer_id) = $forum_db->fetch_row($result_pun_poll);

						//Do we needed to update DB?
						if ($old_answer_id != $answer_id)
						{
							$query_pun_poll = array(
								'UPDATE'	=> 'voting',
								'SET'		=> 'answer_id = '.$answer_id,
								'WHERE'		=> 'topic_id = '.$id.' AND user_id = '.$forum_user['id']
							);
							$forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
							//Replace old answer id with new for correct output
							$old_answer_id = $answer_id;
						}
					}
					else
					{
						//Add new record
						$query_pun_poll = array(
							'INSERT'	=> 'topic_id, user_id, answer_id',
							'INTO'		=> 'voting',
							'VALUES'	=> $id.', '.$forum_user['id'].', '.$answer_id	
						);
						$forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);

						$vote_count++;
					}
					$is_voted_user = true;
				}
				else	
				{
					//Determine user have voted or not
					$query_pun_poll = array(
						'SELECT'	=>	'1',
						'FROM'		=>	'voting',
						'WHERE'		=>	'user_id = '.$forum_user['id'].' AND topic_id = '.$id
					);
					$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);

					$is_voted_user = ($forum_db->num_rows($result_pun_poll) > 0) ? true : false;
				}
			}
		]]></hook>
		<hook id="ed_main_fieldset_end"><![CDATA[
			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

			if ($can_edit_subject)
			{
				//Get info about poll
				$query_pun_poll = array(
					'SELECT'	=>	'question, read_unvote_users, revote, created, days_count, votes_count',
					'FROM'		=>	'questions',
					'WHERE'		=>	'topic_id = '.$cur_post['tid']	
				);
				$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);

				//Is there something?
				if ($forum_db->num_rows($result_pun_poll) > 0)
				{
					list($question, $read_unvote_users, $revote, $created, $days_count, $max_votes_count) = $forum_db->fetch_row($result_pun_poll);
					//TODO:add notices
				?>
				<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">
					<legend class="group-legend">
						<span><?php echo 'Reset' ?></span>
					</legend>
					<div class="sf-set set1">
						<div class="sf-box checkbox">
							<span class="fld-input">
								<input id="fld<?php echo ++ $forum_page['fld_count'] ?>" type="checkbox" value="1" name="reset_poll"/>
							</span>
							<label for="fld<?php echo $forum_page['fld_count'] ?>">
								<span><?php echo $lang_pun_poll['Reset res'] ?></span>
								<?php echo $lang_pun_poll['Reset res notice'] ?>
							</label>
						</div>
					</div>
					<div class="sf-set set2">
						<div class="sf-box checkbox">
							<span class="fld-input">
								<input id="fld<?php echo ++ $forum_page['fld_count'] ?>" type="checkbox" value="1" name="remove_poll"/>
							</span>
							<label for="fld<?php echo $forum_page['fld_count'] ?>">
								<span><?php echo $lang_pun_poll['Remove v'] ?></span>
								<?php echo $lang_pun_poll['Remove v notice'] ?>
							</label>
						</div>
					</div>
				</fieldset>
					<?php

					if ($forum_page['is_admmod'])
					{
						include $ext_info['path'].'/functions.php';
						if ($poll_answers == null)
						{
							$query_pun_poll = array(
								'SELECT'	=>	'id, answer',
								'FROM'		=>	'answers',
								'WHERE'		=>	'topic_id = '.$cur_post['tid'] 
							);
							$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
							$poll_answers = array();
							$poll_ids = array();
							$num_rows = $forum_db->num_rows($result_pun_poll);
							if ($num_rows > 0)
							{
								while ($row = $forum_db->fetch_assoc($result_pun_poll))
								{				
									$poll_ids[] = $row['id'];
									$poll_answers[] = $row['answer'];
								}
								$options_count = $num_rows;
							}			
						}
						form_of_poll(isset($_POST['question_of_poll']) ? forum_htmlencode(forum_trim($_POST['question_of_poll'])) : $question, $poll_answers, $options_count, ($days_poll == null) ? $days_count : $days_poll, ($votes_poll == null) ? $max_votes_count : $votes_poll, $poll_ids);
					}

					?>
				<?php
				}
			}
		]]></hook>

		<hook id="hd_main_elements"><![CDATA[	
			//Is there something to show?
			if (FORUM_PAGE == 'viewtopic' && isset($read_unvote_users))
			{
				//If we don\'t get count of votes
				if (!isset($vote_count))
				{
					$query_pun_poll = array(
						'SELECT'	=>	'COUNT(id)',
						'FROM'		=>	'voting',
						'WHERE'		=>	'topic_id='.$id
					);
					$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
		
					list($vote_count) = $forum_db->fetch_row($result_pun_poll);
				}
				//Showing of vote-form
				if (!isset($end_voting) && (($is_voted_user && $revote) || !$is_voted_user))
				{
					$query_pun_poll = array(
						'SELECT'	=>	'id, answer',
						'FROM'		=>	'answers',
						'WHERE'		=>	'topic_id = '.$id	
					);
					$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
			
					if ($forum_db->num_rows($result_pun_poll) >= 2)
					{
						$vote_form = '';
						$link = forum_link($forum_url['topic'], $id);
						$vote_form = '<form class="frm-form" action="'.$link.'" accept-charset="utf-8" method="post"><div class="ct-box"><p>'.forum_htmlencode($question).'</p></div><fieldset class="frm-group group1">';
						$vote_form .= '<div class="hidden"><input type="hidden" name="csrf_token" value="'.generate_form_token($link).'" /></div>';
						$vote_form .= '<fieldset class="mf-set set1"><legend><span>'.$lang_pun_poll['Options'].'</span></legend><div class="mf-box">';
						
						//Determine old answer of user
						if (!isset($old_answer_id))
						{
							$query_pun_poll = array(
								'SELECT'	=>	'answer_id',
								'FROM'		=>	'voting',
								'WHERE'		=>	'topic_id = '.$id.' AND user_id = '.$forum_user['id']
							);
							$result_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
							
							//If there is something?
							if ($forum_db->num_rows($result_poll) > 0)
								list($old_answer_id) = $forum_db->fetch_row($result_poll);
							unset($result_poll);
						}
						$num = 0;
						while ($answer = $forum_db->fetch_assoc($result_pun_poll)) 
						{
							$vote_form .= '<div class="mf-item"><span class="fld-input">';
							$vote_form .= '<input id="fld'.++$num.'" type="radio"'.((isset($old_answer_id) && $old_answer_id == $answer['id']) ? ' checked="checked"' : '').' value="'.$answer['id'].'" name="answer"/>';			
							$vote_form .= '</span><label for="fld'.$num.'">'.forum_htmlencode($answer['answer']).'</label></div>';
						}
						$vote_form .= '</div></fieldset></fieldset><div class="frm-buttons"><span class="submit"><input type="submit" value="'.$lang_pun_poll['But note'].'" name="vote"/></span></div></form>';
					}
				}
			
				//Showing voting results
				if (isset($end_voting) || $is_voted_user || (!$is_voted_user && $read_unvote_users))
				{
					if ($vote_count > 0)
					{		
						$query_pun_poll = array(
							'SELECT'	=>	'answer, COUNT(v.id)',
							'FROM'		=>	'answers as a',
							'JOINS'		=>	array(
								array(
									'LEFT JOIN'	=> 'voting AS v',
									'ON'		=> 'a.id=v.answer_id'
								)
							),
							'WHERE'		=>	'a.topic_id='.$id,
							'GROUP BY'	=>	'a.id',
							'ORDER BY'	=>	'answer'
						);
						$result_pun_poll = $forum_db->query_build($query_pun_poll) or error(__FILE__, __LINE__);
			
						$num = 0;
						$vote_results = isset($vote_form) ? '' : '<div class="ct-box"><p>'.$lang_pun_poll['Results'].forum_htmlencode($question).'</p></div>';
						$vote_results .= '<div class="ct-group">';
						while (list($answer, $count_v) = $forum_db->fetch_row($result_pun_poll))
						{
							$vote_results .= '<div class="ct-set data-set set'.++$num.'">';
							$vote_results .= '<div class="ct-box data-box"><ul class="ct-legend"><li ><strong>'.forum_htmlencode($answer).'</strong></li></ul>';
							$vote_results .= '<ul class="data-list"><li><span>'.forum_number_format($count_v).' '.forum_number_format((float)$count_v/$vote_count * 100, 2).'%'.'</span></li></ul></div></div>';
						}
						$vote_results .= '</div>';							
					}
					else
						$vote_results = '<div class="ct-box"><p>'.$lang_pun_poll['No votes'].'</p></div>';
				}
				else
					$vote_results = '<div class="ct-box"><p>'.$lang_pun_poll['Dis read vote'].'</p></div>';
			
				if (!empty($main_elements['<!-- forum_main_pagepost_top -->']))
					$tmp_pagepost = $main_elements['<!-- forum_main_pagepost_top -->'];
				$main_elements['<!-- forum_main_pagepost_top -->'] = '<div class="main-head"><h2 class="hn">'.$lang_pun_poll['Header note'].'</h2></div><div class="main-content main-frm">';
				$main_elements['<!-- forum_main_pagepost_top -->'] .= isset($vote_form) ? $vote_form : '';
				$main_elements['<!-- forum_main_pagepost_top -->'] .= $vote_results;
				$main_elements['<!-- forum_main_pagepost_top -->'] .= '</div>';
				$main_elements['<!-- forum_main_pagepost_top -->'] .= isset($tmp_pagepost) ? $tmp_pagepost : '';
			}
		]]></hook>
		<hook id="aop_features_pre_header_load"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';

		]]></hook>

		<hook id="aop_features_validation"><![CDATA[

			if (!isset($form['pun_poll_enable_read']) || $form['pun_poll_enable_read'] != '1') $form['pun_poll_enable_read'] = '0';
			if (!isset($form['pun_poll_enable_revote']) || $form['pun_poll_enable_revote'] != '1') $form['pun_poll_enable_revote'] = '0';
			$form['pun_poll_max_answers'] = intval($form['pun_poll_max_answers']);

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			if ($form['pun_poll_max_answers'] > 100)
				$form['pun_poll_max_answers'] = 100;
			if ($form['pun_poll_max_answers'] < 2)
				$form['pun_poll_max_answers'] = 2;

		]]></hook>
		<hook id="aop_features_avatars_fieldset_end"><![CDATA[

			?>
					<div class="content-head">
						<h2 class="hn"><span><?php echo $lang_pun_poll['Name plugin'] ?></span></h2>
					</div>					
					<fieldset class="frm-group group1">
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box checkbox">
								<span class="fld-input">
									<input id="fld<?php echo ++$forum_page['fld_count'] ?>" type="checkbox" name="form[pun_poll_enable_revote]" value="1"<?php if ($forum_config['p_pun_poll_enable_revote'] == '1') echo ' checked="checked"' ?>/>
								</span>
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
									<span><?php echo $lang_pun_poll['Disable revoting info'] ?></span>
									<?php echo $lang_pun_poll['Disable revoting'] ?>
								</label>
							</div>
						</div>
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box checkbox">
								<span class="fld-input">
									<input id="fld<?php echo ++$forum_page['fld_count'] ?>" type="checkbox" name="form[pun_poll_enable_read]" value="1"<?php if ($forum_config['p_pun_poll_enable_read'] == '1') echo ' checked="checked"' ?>/>
								</span>
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
									<span><?php echo $lang_pun_poll['Disable see results'] ?></span>
								</label>
								<?php echo $lang_pun_poll['Disable see results info'] ?>
							</div>
						</div>
						<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
							<div class="sf-box text">
								<label for="fld<?php echo ++$forum_page['fld_count'] ?>">
									<span><?php echo $lang_pun_poll['Maximum answers info'] ?></span>
									<small><?php echo $lang_pun_poll['Maximum answers'] ?></small>
								</label>
								</br>
								<span class="fld-input">
									<input id="fld<?php echo $forum_page['fld_count'] ?>" type="text" name="form[pun_poll_max_answers]" size="6" maxlength="6" value="<?php echo $forum_config['p_pun_poll_max_answers'] ?>"/>
								</span>
							</div>
						</div>
					</fieldset>					
			<?php

		]]></hook>

		<hook id="agr_edit_end_qr_update_group"><![CDATA[

			$query_poll['SET'] .= ', g_poll_add='.((isset($_POST['poll_add']) && $_POST['poll_add'] == '1') ? 1 : 0);

		]]></hook>

		<hook id="agr_add_edit_group_user_permissions_fieldset_end"><![CDATA[

			if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
				include_once $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
			else
				include_once $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
			?>

				<fieldset class="mf-set set<?php echo ++$forum_page['item_count'] ?>">
					<legend>
						<span><?php echo $lang_pun_poll['Permission'] ?></span>
					</legend>
					<div class="mf-box">
						<div class="mf-item">
							<span class="fld-input">
								<input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="poll_add" value="1"<?php if ($group['g_poll_add'] == '1') echo ' checked="checked"' ?>/>
							</span>
							<label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo $lang_pun_poll['Poll add'] ?></label>
						</div>
					</div>
				</fieldset>

			<?php

		]]></hook>

		<hook id="co_common"><![CDATA[
			$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));
		]]></hook>

		<hook id="ft_about_end" priority="10"><![CDATA[
			if (!defined('PUN_EXTENSIONS_USED') && !empty($pun_extensions_used))
			{
				define('PUN_EXTENSIONS_USED', 1);
				echo '<p id="extensions-used">Currently used extensions: '.implode(', ', $pun_extensions_used).'. Copyright &copy; 2008 <a href="http://punbb.informer.com/">PunBB</a></p>';
			}
		]]></hook>
	</hooks>
</extension>
