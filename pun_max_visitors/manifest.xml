<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

	Copyright (C) 2008  PunBB

	PunBB is free software; you can redistribute it and/or modify it
	under the terms of the GNU General Public License as published
	by the Free Software Foundation; either version 2 of the License,
	or (at your option) any later version.

	PunBB is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place, Suite 330, Boston,
	MA  02111-1307  USA

***********************************************************************
-->

	<extension engine="1.0">
	<id>pun_max_visitors</id>
	<title>Maximum number of visitors</title>
	<version>0.5a</version>
	<description>Shows in what day there was a maximum number of visitors ever registered.</description>
	<author>PunBB Development Team</author>

	<minversion>1.3 SVN</minversion>
	<maxtestedon>1.3 SVN</maxtestedon>

	<hooks>
		<hook id="in_start"><![CDATA[
			if (!defined('PUN_ROOT_URL'))
				define('PUN_ROOT_URL', $_SERVER['REQUEST_URI']);
		]]></hook>							  
		<hook id="ft_about_end"><![CDATA[									
			if (defined('PUN_ROOT_URL'))
			{
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'/'.$ext_info['id'].'.php';
				else
					require $ext_info['path'].'/lang/English/'.$ext_info['id'].'.php';
				if (file_exists($ext_info['path'].'/max_visitors_mas.php'))
				{
					$mas = array();
					require $ext_info['path'].'/max_visitors_mas.php';
					$query = array(
						'SELECT'	=> 'Count(user_id)',
						'FROM'		=> 'online'
					);
					$result =  $forum_db->query_build($query) or error(__FILE__, __LINE__);
					$mas = $forum_db->fetch_assoc($result);   
					if ($max_visitors_mas['max_visitors'] < $mas['Count(user_id)'])
					{
						$max_visitors_mas['date'] = date('Y-M-d');
						$max_visitors_mas['max_visitors'] = $mas['Count(user_id)'];
						$fh = @fopen($ext_info['path'].'max_visitors_mas.php','w+');	
						if (!$fh)
							error($lang_max_visitors['Error'], __FILE__, __LINE__);

						fwrite($fh, '<?php'."\n\n".'$max_visitors_mas = '.var_export($max_visitors_mas, true).';'."\n\n".'?>');
						fclose($fh);
					}
				}
				else
				{
					$fh = @fopen($ext_info['path'].'/max_visitors_mas.php','w+');
					if (!$fh)
						error($lang_max_visitors['Error'], __FILE__, __LINE__);
					$max_visitors_mas = array();		
					$max_visitors_mas['date'] = date('Y-M-d');
					$query = array(
						'SELECT'	=> 'Count(user_id)',
						'FROM'		=> 'online'
					);
					$result =  $forum_db->query_build($query) or error(__FILE__, __LINE__);
					$mas = $forum_db->fetch_assoc($result);   
		 			$max_visitors_mas['max_visitors'] = $mas['Count(user_id)'];
					fwrite($fh, '<?php'."\n\n".'$max_visitors_mas = '.var_export($max_visitors_mas, true).';'."\n\n".'?>');
					fclose($fh);
				}
							
				$buffer_old = ob_get_contents();
				ob_clean();
				
				?>
				<div id="pun-main" class="main"> 
				<div class="main-head">
				 <h2><span><?php echo $lang_max_visitors['Maximum visitors'];?></span></h2>
				</div>		  
				
				<div id="Maximum visitors" class="main-content category">
				  <table cellspacing="0" summary="Maximum visitors">
					  <thead>
						  <tr>
							<td> <?php echo $lang_max_visitors['The maximum visitors'].' '.$max_visitors_mas['max_visitors'].' ('.$max_visitors_mas['date'].')'; ?> </td>
						  </tr>
					  </thead>
				  </table>
				</div>
				
				</div>
				<?php
				  echo substr($buffer_old, 0, strlen($buffer_old));
			}				  
		]]></hook>
	</hooks>
</extension>
